{
  "hash": "8dded228c39bc470b9f27c0ab398a7a0",
  "result": {
    "markdown": "---\ntitle: \"Utilisation de modèles de régression à coefficients variant dans le temps pour la prévision conjoncturelle\"\nsubtitle: \"Atelier D2E\"\nauthor: \n- Claire du Campe de Rosamel\n- Alain Quartier-la-Tente\nlang: fr\nlanguage: \n title-block-author-plural: Auteurs\n title-block-published: Date\nformat: \n html:\n   number-sections: true\n   toc: true\n   css: \"css/callout.css\"\ndate: 03/16/2023\ndate-format: \"D MMMM YYYY\"\n---\n\n\n> L'objectif de ce TP est d'apprendre à utiliser quelques fonctionnalités du package `tvCoef` pour l'estimation de modèles de régression à coefficients variant dans le temps.\n\nLes packages suivants seront utilisés :\n\n\n::: {.cell}\n\n```{.r .cell-code}\npackages_to_install <- c(\"dygraphs\", \"car\", \"dynlm\")\n\npackages <- installed.packages()[,\"Package\"][! packages_to_install %in% installed.packages()[,\"Package\"]]\nif (length(packages) > 0) {\n    install.packages(packages)\n}\nif (\"tvCoef\" %in% installed.packages()[,\"Package\"]) {\n  remotes::install_github(\"palatej/rjd3toolkit\")\n  remotes::install_github(\"palatej/rjd3sts\")\n  remotes::install_github(\"AQLT/tvCoef\")\n}\n```\n:::\n\n\nPour l'installation de tvCoef, voir le [manuel d'installation](manuel_installation.qmd).\nSi vous utiliser le <https://datalab.ssp.cloud.fr>, créer une instance en cliquant ici : [![Onyxia](https://img.shields.io/badge/Launch-Datalab-orange?logo=R)](https://datalab.sspcloud.fr/launcher/ide/rstudio?autoLaunch=true&service.image.custom.enabled=true&service.image.pullPolicy=%C2%ABAlways%C2%BB&service.image.custom.version=%C2%ABaqlt%2Fatelier-tvcoef%3Alatest%C2%BB)\n\nPour ce TP nous utiliserons les données de la base `tvCoef::manufacturing`pour prévoir l'évolution trimestrielle de la production du secteur des autres industries manufacturières (C5, `prod_c5`) à partir de :\n\n- l'acquis de croissance au premier mois du trimestre de l'indice de production industrielle du même secteur (`overhang_ipi1_c5`) ;\n\n- des soldes d'opinion de l'Insee et de la Banque de France.\nCes soldes d'opinion sont trimestrialisés en prenant la place du mois dans le trimestre\\ : \n\n  - `insee_bc_c5_m3` : climat des affaires au 3^e^ mois du trimestre (mars, juin, septembre, décembre)\n  \n  - `insee_oscd_c5_m2` : niveau des carnets de commandes au 2^e^ mois du trimestre (février, mai, septembre, novembre)\n  \n  - `insee_tppre_c5_m3` : solde d'opinion sur l'évolution future de la production au 3^e^ mois du trimestre (février, mai, septembre, novembre).\n  \n  - `bdf_tuc_c5_m2` : taux d'utilisation des capacités de production au deuxième mois du trimestre (février, mai, septembre, novembre).\n\nLes deux dernières variables sont utilisées en différence.\n\nPar simplification, nous estimerons ici le modèle entre le 1993T1 et 2019T4 : pour estimer le modèle au-delà cette date, il faudrait ajouter des indicatrices au cours de l'année 2020 et vérifier si le modèle estimé est toujours bien spécifié.\n\n\nLe modèle peut alors être estimé en utilisant par exemple la fonction `dynlm::dynlm()`^[\nL'avantage de `dynlm` par rapport à `lm` est qu'il permet de gérer directement la différenciation des variables sans avoir à créer de variable temporaire.\n] :\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tvCoef)\nlibrary(dynlm)\ndata <- window(manufacturing, start = 1993, end = c(2019, 4))\ny <- data[, \"prod_c5\"]\nmodel_c5 <- dynlm(\n  formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + insee_oscd_c5_m2\n  + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, 1),\n  data = data\n)\nmodel_c5\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nTime series regression with \"ts\" data:\nStart = 1993(2), End = 2019(4)\n\nCall:\ndynlm(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + \n    insee_oscd_c5_m2 + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, \n    1), data = data)\n\nCoefficients:\n               (Intercept)            overhang_ipi1_c5  \n                 -15.94185                     0.12222  \n            insee_bc_c5_m3            insee_oscd_c5_m2  \n                   0.14891                    -0.04347  \ndiff(insee_tppre_c5_m3, 1)      diff(bdf_tuc_c5_m2, 1)  \n                   0.03711                     0.01846  \n```\n:::\n:::\n\n\nLes prévisions dans l'échantillon (*in sample*) peuvent être extraites avec les fonctions `fitted()` ou `predict()` et les prévisions en temps-réel (*out of sample*) avec la fonction `tvCoef::oos_prev()`.\n\nPour évaluer la qualité en temps-réel, nous utiliserons les résidus à partir de 2000 :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprev_oos_lm <- oos_prev(model_c5)\nres_lm_is <- residuals(model_c5)\nres_lm_oos <- prev_oos_lm$residuals\nrmse_lm <- c(IS = rmse(res_lm_is), OOS = rmse(res_lm_oos))\nrmse_lm\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       IS       OOS \n0.7656267 0.9298085 \n```\n:::\n:::\n\n\nPour tracer les prévisions, on peut utiliser la fonction `plot()` :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(window(y, start = 2000))\nlines(prev_oos_lm$prevision, col = \"red\")\nlegend(\"bottomleft\", legend = c(\"y\",\"Prev. temps réel\"),\n       col= c(\"black\", \"red\"), lty = 1)\n```\n\n::: {.cell-output-display}\n![](TP_files/figure-html/prev-lm-1.png){width=672}\n:::\n:::\n\n\n# Régression par morceaux\n\nPour utiliser la régression par morceaux, la première étape est d'analyser les potentielles dates de rupture.\nPour cela nous utiliserons la fonction `tvCoef::piece_reg()` (qui s'appuie sur le package `strucchange`, voir `?strucchange::breakpoints()` pour plus d'informations).\n\n::: {.callout-note}\n## Exercice\nUtiliser la fonction `tvCoef::piece_reg()` sur le modèle précédent et regarder les résultats : y a-t-il des dates de ruptures ? \nPeuvent-elles être interprétées ? \n\nEn utilisant notamment `oos_prev()`, comparer la qualité prédictive des modèles.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreg_morceaux <- piece_reg(model_c5)\n# Ici une date de rupture\n# Si pas de rupture détectée, le modèle renvoyé est le modèle initial\nreg_morceaux \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$model\n\nTime series regression with \"ts\" data:\nStart = 1993(2), End = 2019(4)\n\nCall:\ndynlm::dynlm(formula = as.formula(formula), data = data2)\n\nCoefficients:\n                `(Intercept)_2008.5`               overhang_ipi1_c5_2008.5  \n                           -7.772228                              0.120109  \n               insee_bc_c5_m3_2008.5               insee_oscd_c5_m2_2008.5  \n                            0.073437                             -0.005285  \n `diff(insee_tppre_c5_m3, 1)_2008.5`       `diff(bdf_tuc_c5_m2, 1)_2008.5`  \n                            0.027550                              0.016886  \n               `(Intercept)_2019.75`              overhang_ipi1_c5_2019.75  \n                          -18.131296                              0.480903  \n              insee_bc_c5_m3_2019.75              insee_oscd_c5_m2_2019.75  \n                            0.169182                             -0.052009  \n`diff(insee_tppre_c5_m3, 1)_2019.75`      `diff(bdf_tuc_c5_m2, 1)_2019.75`  \n                            0.054804                              0.021315  \n\n\n$start\n[1] 1993    2\n\n$end\n[1] 2019    4\n\n$frequency\n[1] 4\n\n$breakdates\n[1] 2008.5\n\n$tvlm\n[1] FALSE\n\nattr(,\"class\")\n[1] \"piecereg\"\n```\n:::\n:::\n\nL'objet précédent est une liste qui contient différentes informations, notamment :\n\n- `model` : le modèle `dynlm` estimé ;\n\n- `breakdates` : la date de rupture : 2008T3.\n\nAnalysons maintenant les erreurs de prévision :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprev_oos_rm <- oos_prev(reg_morceaux)\nres_rm_is <- residuals(reg_morceaux$model)\nres_rm_oos <- prev_oos_rm$residuals\nstart(res_rm_oos) # Commence en 2000 T2\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2000    2\n```\n:::\n\n```{.r .cell-code}\nrmse_rm <- c(IS = rmse(res_rm_is), OOS = rmse(res_rm_oos))\nrbind(rmse_lm, rmse_rm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               IS       OOS\nrmse_lm 0.7656267 0.9298085\nrmse_rm 0.6008502 1.5042050\n```\n:::\n:::\n\n\nElle sont ici réduites dans l'échantillon mais augmentent en temps réel ! \nEn regardant plus précisément, cela vient d'erreurs élevées autour de la date de rupture car l'estimation n'est pas suffisamment robuste !\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(res_rm_oos, col = \"red\", main = \"Résidus en temps-réel\")\nlines(res_lm_oos, col = \"black\")\nlegend(\"topleft\", legend = c(\"LM\",\"Reg. par morceaux\"),\n       col= c(\"black\", \"red\"), lty = 1)\n```\n\n::: {.cell-output-display}\n![](TP_files/figure-html/oos-lm-rm-1.png){width=672}\n:::\n:::\n\n\nEn analysant les prévisions à partir de 2010, les erreurs sont réduites par rapport à précédemment mais restent plus élevées que celles de la régression linéaire :\n\n\n::: {.cell}\n\n```{.r .cell-code}\napply(window(ts.union(res_lm_oos, res_rm_oos), start = 2010), 2, rmse)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nres_lm_oos res_rm_oos \n 0.7431644  0.9633194 \n```\n:::\n:::\n\n\n:::\n\n::: {.callout-note}\n## Exercice\n\nLe modèle précédent suppose une rupture sur toutes les variables : est-ce réaliste dans ce cas ? \nAppliquer la fonction `tvCoef::hansen.test()` sur votre modèle et interpréter les résultats.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhansen.test(model_c5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nVariable                  L        Stat     Conclusion \n______________________________________________________________ \n(Intercept)                  0.28297   0.47   FALSE   \noverhang_ipi1_c5             1.00779   0.47    TRUE   \ninsee_bc_c5_m3               0.33875   0.47   FALSE   \ninsee_oscd_c5_m2             0.07143   0.47   FALSE   \ndiff(insee_tppre_c5_m3, 1)   0.33877   0.47   FALSE   \ndiff(bdf_tuc_c5_m2, 1)       0.30556   0.47   FALSE   \nVariance                     0.28409   0.47   FALSE   \nJoint Lc                     1.92646   2.11    TRUE   \n\n\nLecture: True means reject H0 at level 5% \n```\n:::\n:::\n\nLe test de Hansen conclut que seul l'acquis d'IPI évolue.\nAttention à l'interprétation du test sur la constante : si cette variable évolue il est possible que la constante aussi.\n\nOn peut également faire des tests de Fisher sur le modèle précédent pour tester si les coefficients sont égaux entre les sous-périodes.\nCela peut être fait avec la fonction `car::linearHypothesis()` :\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# on rejette H0 => non constance des coefficients\ncar::linearHypothesis(reg_morceaux$model, \"`(Intercept)_2008.5` = `(Intercept)_2019.75`\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear hypothesis test\n\nHypothesis:\n(Intercept)_2008.5` - Intercept)_2019.75` = 0\n\nModel 1: restricted model\nModel 2: y ~ 0 + (`(Intercept)_2008.5` + overhang_ipi1_c5_2008.5 + insee_bc_c5_m3_2008.5 + \n    insee_oscd_c5_m2_2008.5 + `diff(insee_tppre_c5_m3, 1)_2008.5` + \n    `diff(bdf_tuc_c5_m2, 1)_2008.5` + `(Intercept)_2019.75` + \n    overhang_ipi1_c5_2019.75 + insee_bc_c5_m3_2019.75 + insee_oscd_c5_m2_2019.75 + \n    `diff(insee_tppre_c5_m3, 1)_2019.75` + `diff(bdf_tuc_c5_m2, 1)_2019.75`)\n\n  Res.Df    RSS Df Sum of Sq      F  Pr(>F)  \n1     96 40.182                              \n2     95 38.629  1    1.5522 3.8174 0.05366 .\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\n# on rejette H0 => non constance des coefficients\ncar::linearHypothesis(reg_morceaux$model, \"overhang_ipi1_c5_2019.75 = overhang_ipi1_c5_2008.5\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear hypothesis test\n\nHypothesis:\n- overhang_ipi1_c5_2008.5  + overhang_ipi1_c5_2019.75 = 0\n\nModel 1: restricted model\nModel 2: y ~ 0 + (`(Intercept)_2008.5` + overhang_ipi1_c5_2008.5 + insee_bc_c5_m3_2008.5 + \n    insee_oscd_c5_m2_2008.5 + `diff(insee_tppre_c5_m3, 1)_2008.5` + \n    `diff(bdf_tuc_c5_m2, 1)_2008.5` + `(Intercept)_2019.75` + \n    overhang_ipi1_c5_2019.75 + insee_bc_c5_m3_2019.75 + insee_oscd_c5_m2_2019.75 + \n    `diff(insee_tppre_c5_m3, 1)_2019.75` + `diff(bdf_tuc_c5_m2, 1)_2019.75`)\n\n  Res.Df    RSS Df Sum of Sq      F    Pr(>F)    \n1     96 48.734                                  \n2     95 38.629  1    10.105 24.851 2.781e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\n# on ne rejette pas H0 => constance des coefficients\ncar::linearHypothesis(reg_morceaux$model, \"`diff(insee_tppre_c5_m3, 1)_2019.75` = `diff(insee_tppre_c5_m3, 1)_2008.5`\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear hypothesis test\n\nHypothesis:\n- diff(insee_tppre_c5_m3,_2008.5`  + diff(insee_tppre_c5_m3,_2019.75` = 0\n\nModel 1: restricted model\nModel 2: y ~ 0 + (`(Intercept)_2008.5` + overhang_ipi1_c5_2008.5 + insee_bc_c5_m3_2008.5 + \n    insee_oscd_c5_m2_2008.5 + `diff(insee_tppre_c5_m3, 1)_2008.5` + \n    `diff(bdf_tuc_c5_m2, 1)_2008.5` + `(Intercept)_2019.75` + \n    overhang_ipi1_c5_2019.75 + insee_bc_c5_m3_2019.75 + insee_oscd_c5_m2_2019.75 + \n    `diff(insee_tppre_c5_m3, 1)_2019.75` + `diff(bdf_tuc_c5_m2, 1)_2019.75`)\n\n  Res.Df    RSS Df Sum of Sq      F Pr(>F)\n1     96 39.171                           \n2     95 38.629  1   0.54182 1.3325 0.2513\n```\n:::\n:::\n\n:::\n\n::: {.callout-note}\n## Exercice\n\nEn exploitant les résultats de l'exercice précédent, simplifier le modèle de régression par morceaux.\n\nOn pourra pour cela utiliser le paramètre `fixed_var` de `piece_reg()` pour fixer certaines variables (i.e. : ne pas découper les régresseurs).\n\nComparer les prévisions avec les modèles précédents.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\n\nIci nous allons fixer toutes les variables sauf les deux premières (constante + acquis d'IPI -- *overhang*)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreg_morceaux2 <- piece_reg(model_c5, fixed_var = c(3, 4, 5, 6))\n\n# Rmq : la date de rupture est détectée sur le modèle complet et non\n#  sur le sous-modèle avec des variables fixes\nreg_morceaux2 \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$model\n\nTime series regression with \"ts\" data:\nStart = 1993(2), End = 2019(4)\n\nCall:\ndynlm::dynlm(formula = as.formula(formula), data = data2)\n\nCoefficients:\n              insee_bc_c5_m3              insee_oscd_c5_m2  \n                     0.12320                      -0.03110  \n`diff(insee_tppre_c5_m3, 1)`      `diff(bdf_tuc_c5_m2, 1)`  \n                     0.03626                       0.01969  \n        `(Intercept)_2008.5`       overhang_ipi1_c5_2008.5  \n                   -13.07645                       0.09204  \n       `(Intercept)_2019.75`      overhang_ipi1_c5_2019.75  \n                   -13.10151                       0.52974  \n\n\n$start\n[1] 1993    2\n\n$end\n[1] 2019    4\n\n$frequency\n[1] 4\n\n$breakdates\n[1] 2008.5\n\n$tvlm\n[1] FALSE\n\nattr(,\"class\")\n[1] \"piecereg\"\n```\n:::\n\n```{.r .cell-code}\nprev_oos_rm2 <- oos_prev(reg_morceaux2)\nres_rm2_is <- residuals(reg_morceaux2$model)\nres_rm2_oos <- prev_oos_rm2$residuals\nrmse_rm2 <- c(IS = rmse(res_rm2_is), OOS = rmse(res_rm2_oos))\nrbind(rmse_lm, rmse_rm, rmse_rm2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                IS       OOS\nrmse_lm  0.7656267 0.9298085\nrmse_rm  0.6008502 1.5042050\nrmse_rm2 0.6364012 1.4565471\n```\n:::\n\n```{.r .cell-code}\n# Après 2010\napply(window(ts.union(res_lm_oos, res_rm_oos, res_rm2_oos), start = 2010), 2, rmse)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n res_lm_oos  res_rm_oos res_rm2_oos \n  0.7431644   0.9633194   0.7018949 \n```\n:::\n:::\n\nCela permet d'améliorer la qualité de la prévision en temps-réel mais pas celle dans l'échantillon.\n\n:::\n\n# Régression locale\n\nPour rappel, la régression locale revient, pour chaque date $t$ à estimer $\\beta_t$\n\n$$\n\\DeclareMathOperator{\\argmin}{argmin}\n\\hat \\beta = \\underset{\\theta_0}{\\argmin}\\sum_{j=1}^T\\left(y_{j}-x_j\\theta_0\\right)^2K_b\\left(\\frac{j-t}{T}\\right)\n$$\n\nDans le package ici utilisé (`tvReg`), le noyau utilisé par défaut est le noyau tricube :\n\n$$\nK(x)=\\frac{35}{32}\\left(\n  1-\n  \\left\\lvert\n  x\n  \\right\\lvert^2\n\\right)^3 \\mathbb 1_{|x| \\leq 1}\n\\text{ et }\nK_b(x)=\\frac 1 b K(x/b)\n$$\n\nPour estimer le modèle, nous utilisons la fonction `tvReg::tvLM` dont le premier paramètre est une formule.\nMais contrairement à `dynlm`, `tvLM` ne gère pas directement les variables en différence :\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tvReg)\ntvReg::tvLM(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + insee_oscd_c5_m2\n  + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, 1),\n  data = data)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in model.frame.default(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + : les longueurs des variables diffèrent (trouvé pour 'diff(insee_tppre_c5_m3, 1)')\n```\n:::\n:::\n\n\nPour éviter les problèmes liées au variables en différence, nous récupérons les données transformées de `dynlm` en utilisant la fonction `tvCoef::get_data(model_c5)`, ce qui permet également de simplifier la formule en `prod_c5 ~ .`(puisque la base de données alors utilisée ne contient que les exogènes utiles).\n\n::: {.callout-note}\n## Exercice\n\nEstimer le modèle en utilisant les indications précédentes.\n\nQuelle fenêtre est utilisée (paramètre $b$) ? \nEst-ce que les résultats sont différents de ceux de la régression linéaire ? \nTracer les coefficients obtenus à chaque date (fonction `coef()` pour les extraire, il faudrait reconvertir le résultat en objet `ts()`)\n\nComparer les erreurs de prévision dans l'échantillon avec ceux des modèles précédents.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\n\nLa fenêtre retenue est de 0,31 : les résultats seront donc différents de ceux de la régression linéaire.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntvlm <- tvReg::tvLM(formula = prod_c5 ~ .,\n                 data = get_data(model_c5))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCalculating regression bandwidth... bw =  0.3066338 \n```\n:::\n\n```{.r .cell-code}\ncoefs_tvlm <- ts(coef(tvlm), end = end(data), frequency = frequency(data))\nplot(coefs_tvlm)\n```\n\n::: {.cell-output-display}\n![](TP_files/figure-html/coef-tvlm-1.png){width=672}\n:::\n:::\n\nIci toutes les coefficients sont variables alors que certains pourraient être fixes comme vu dans la partie précédente.\nPour fixer certaines variables, on pourrait faire une régression en deux étapes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres_tvlm_is <- residuals(tvlm)\nrmse_tvlm <- c(IS = rmse(res_tvlm_is), OOS = NA)\nrbind(rmse_lm, rmse_rm, rmse_rm2, rmse_tvlm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                 IS       OOS\nrmse_lm   0.7656267 0.9298085\nrmse_rm   0.6008502 1.5042050\nrmse_rm2  0.6364012 1.4565471\nrmse_tvlm 0.5601224        NA\n```\n:::\n:::\n\n\nLe RMSE dans l'échantillon est réduit.\n:::\n\n::: {.callout-note}\n## Exercice\n\nL'objectif de cet exercice est de calculer les prévisions hors échantillon.\n\nAppliquer la fonction `tvCoef::oos_prev()` au modèle précédent avec les paramètres `end = end(data), frequency = frequency(data)` (utiles pour garder la structure temporelle des données) : quels sont les paramètres réestimés ?\n\nAppliquer maintenant la même fonction avec le paramètre `fixed_bw = TRUE`.\nÀ quoi cela correspond ?\nComparer les erreurs de prévisions obtenus.\n:::\n\n:::: {.callout-tip collapse=\"true\"}\n## Solution\n\nDans les modèles de régression locales, il y a deux sources de révisions en temps-réel :\n\n1. Actualisation des coefficients du fait de l'ajout de nouveaux points (noyau asymétrique utilisé pour les premières estimations)\n\n2. Actualisation de la fenêtre.\n\n\n::: {.callout-tip icon=false}\n## Actualisation de la fenêtre et des coefficients\n\nPar défaut, avec `oos_prev()` tous les paramètres sont réestimés.\nC'est en particulier le cas de la fenêtre qui est réestimée à chaque date, à chaque observation :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprev_oos_tvlm_all <- oos_prev(tvlm, end = end(data), frequency = frequency(data))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  0.7229482 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  20 \nCalculating regression bandwidth... bw =  3.84218 \nCalculating regression bandwidth... bw =  2.379419 \nCalculating regression bandwidth... bw =  1.471069 \nCalculating regression bandwidth... bw =  1.336507 \nCalculating regression bandwidth... bw =  2.187982 \nCalculating regression bandwidth... bw =  2.720982 \nCalculating regression bandwidth... bw =  1.861825 \nCalculating regression bandwidth... bw =  1.332401 \nCalculating regression bandwidth... bw =  1.423126 \nCalculating regression bandwidth... bw =  1.378801 \nCalculating regression bandwidth... bw =  1.383647 \nCalculating regression bandwidth... bw =  1.348802 \nCalculating regression bandwidth... bw =  1.319569 \nCalculating regression bandwidth... bw =  1.146523 \nCalculating regression bandwidth... bw =  1.095173 \nCalculating regression bandwidth... bw =  0.9674586 \nCalculating regression bandwidth... bw =  0.9737833 \nCalculating regression bandwidth... bw =  0.4515073 \nCalculating regression bandwidth... bw =  0.6010299 \nCalculating regression bandwidth... bw =  1.125076 \nCalculating regression bandwidth... bw =  0.7800465 \nCalculating regression bandwidth... bw =  0.3350958 \nCalculating regression bandwidth... bw =  0.3181148 \nCalculating regression bandwidth... bw =  0.3175687 \nCalculating regression bandwidth... bw =  0.3192663 \nCalculating regression bandwidth... bw =  0.3038067 \nCalculating regression bandwidth... bw =  0.3062916 \nCalculating regression bandwidth... bw =  0.321897 \nCalculating regression bandwidth... bw =  0.2823154 \nCalculating regression bandwidth... bw =  0.282671 \nCalculating regression bandwidth... bw =  0.2813243 \nCalculating regression bandwidth... bw =  0.2712527 \nCalculating regression bandwidth... bw =  0.2668975 \nCalculating regression bandwidth... bw =  0.2663408 \nCalculating regression bandwidth... bw =  0.2654891 \nCalculating regression bandwidth... bw =  0.2616418 \nCalculating regression bandwidth... bw =  0.256943 \nCalculating regression bandwidth... bw =  0.252477 \nCalculating regression bandwidth... bw =  0.256979 \nCalculating regression bandwidth... bw =  0.2529721 \nCalculating regression bandwidth... bw =  0.2465582 \nCalculating regression bandwidth... bw =  0.2405544 \nCalculating regression bandwidth... bw =  0.2476612 \nCalculating regression bandwidth... bw =  0.2447846 \nCalculating regression bandwidth... bw =  0.2402012 \nCalculating regression bandwidth... bw =  0.2380975 \nCalculating regression bandwidth... bw =  0.2325063 \nCalculating regression bandwidth... bw =  0.2455257 \nCalculating regression bandwidth... bw =  0.2563558 \nCalculating regression bandwidth... bw =  0.2392887 \nCalculating regression bandwidth... bw =  0.2319362 \nCalculating regression bandwidth... bw =  0.2385437 \nCalculating regression bandwidth... bw =  0.2172559 \nCalculating regression bandwidth... bw =  0.2134491 \nCalculating regression bandwidth... bw =  0.3141551 \nCalculating regression bandwidth... bw =  0.2627992 \nCalculating regression bandwidth... bw =  0.2459824 \nCalculating regression bandwidth... bw =  0.2756304 \nCalculating regression bandwidth... bw =  0.2683644 \nCalculating regression bandwidth... bw =  0.2585477 \nCalculating regression bandwidth... bw =  0.2563214 \nCalculating regression bandwidth... bw =  0.3066338 \n```\n:::\n\n```{.r .cell-code}\nall_bw <- ts(sapply(prev_oos_tvlm_all$model, `[[`, \"bw\"),\n             end = end(prev_oos_tvlm_all$prevision),\n             frequency = frequency(data))\nplot(all_bw)\n```\n\n::: {.cell-output-display}\n![](TP_files/figure-html/bw-tvlm-soos-1.png){width=672}\n:::\n\n```{.r .cell-code}\nres_tvlm_all_oos <- prev_oos_tvlm_all$residuals\nrmse_tvlm[\"OOS\"] <- rmse(res_tvlm_all_oos)\nrbind(rmse_lm, rmse_rm, rmse_rm2, rmse_tvlm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                 IS       OOS\nrmse_lm   0.7656267 0.9298085\nrmse_rm   0.6008502 1.5042050\nrmse_rm2  0.6364012 1.4565471\nrmse_tvlm 0.5601224 0.9953914\n```\n:::\n\n```{.r .cell-code}\n# Après 2010\napply(window(ts.union(res_lm_oos, res_rm_oos, res_rm2_oos, res_tvlm_all_oos), start = 2010), 2, rmse)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      res_lm_oos       res_rm_oos      res_rm2_oos res_tvlm_all_oos \n       0.7431644        0.9633194        0.7018949        0.8571885 \n```\n:::\n:::\n\n::: \n\n::: {.callout-tip icon=false}\n## Actualisation des coefficients uniquement\n\nFixons maintenant la fenêtre à la dernière valeur estimée :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprev_oos_tvlm_lastbw <- oos_prev(tvlm, end = end(data), frequency = frequency(data),fixed_bw = TRUE)\nres_tvlm_lastbw_oos <- prev_oos_tvlm_lastbw$residuals\nrmse_tvlm[\"OOS\"] <- rmse(res_tvlm_lastbw_oos)\nrbind(rmse_lm, rmse_rm, rmse_rm2, rmse_tvlm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                 IS       OOS\nrmse_lm   0.7656267 0.9298085\nrmse_rm   0.6008502 1.5042050\nrmse_rm2  0.6364012 1.4565471\nrmse_tvlm 0.5601224 1.1195514\n```\n:::\n\n```{.r .cell-code}\n# Après 2010\napply(window(ts.union(res_lm_oos, res_rm_oos, res_rm2_oos, res_tvlm_all_oos, res_tvlm_lastbw_oos), start = 2010), 2, rmse)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         res_lm_oos          res_rm_oos         res_rm2_oos    res_tvlm_all_oos \n          0.7431644           0.9633194           0.7018949           0.8571885 \nres_tvlm_lastbw_oos \n          0.7904943 \n```\n:::\n:::\n\n\nLe RMSE en temps-réel est réduit par rapport à précédemment mais il reste plus élevé qu'avec la régression linéaire.\n:::\n::::\n\n::: {.callout-remarque}\n## Remarque\n\nPour fixer certaines variables, on pourrait faire une régression en deux étapes.\nLa fonction `rmse_prev()` permet de calculer les prévisions dans l'échantillon et hors échantillon sur le modèle de régression linéaire, la régression par morceaux, la régression locale en fixant ou non certains coefficients.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomp_prev <- rmse_prev(model_c5, fixed_var = c(3, 4, 5, 6), fixed_bw = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCalculating regression bandwidth... bw =  0.3066338 \nCalculating regression bandwidth... bw =  0.2701166 \n```\n:::\n\n```{.r .cell-code}\ncomp_prev\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                       RMSE_in_sample RMSE_out_of_sample\nlm                          0.7656267          0.9298085\npiece_lm                    0.6008502          1.5042050\npiece_lm fixed coeff        0.5043489          1.4565471\nTvLM                        0.5601224          1.1195514\npiece_tvlm                  0.6364012          1.6177417\npiece_tvlm fixed coeff      0.5127197          2.6673561\nTvLM fixed coeff            0.6509789          0.8886024\n```\n:::\n:::\n\nSept modèles différents sont estimés, dans l'ordre :\n\n1. Modèle de régression linéaire.\n\n2. Régression linéaire par morceaux où toutes les variables divisées en fonction de la date de rupture.\n\n3. Régression linéaire par morceaux où toutes les variables, sauf celles spécifiées par `fixed_var`, sont  divisées en fonction de la date de rupture.\n\n4. Régression locale.\n\n5. Régression locale avec toutes les variables divisées en fonction de la date de rupture.\n\n6. Régression locale où toutes les variables, sauf celles spécifiées par `fixed_var`, sont  divisées en fonction de la date de rupture.\n\n7. Régression locale où les variables celles spécifiées par `fixed_var` sont estimées par une régression linéaire (coefficients fixes sur l'ensemble de la période).\n\n\nOn peut ensuite récupérer tous les résidus en temps réel :\n\n::: {.cell}\n\n```{.r .cell-code}\ncomp_prev_tr <- do.call(cbind, lapply(comp_prev$prevision, `[[`, \"residuals\"))\napply(window(comp_prev_tr, start = 2010), 2, rmse)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             prev_lm        prev_piece_lm   prev_piece_lm_fixe \n           0.7431644            0.9633194            0.7018949 \n           prev_tvlm      prev_piece_tvlm prev_piece_tvlm_fixe \n           0.7904943            0.9564709            0.7897816 \n      prev_tvlm_fixe \n           0.6568764 \n```\n:::\n:::\n\n:::\n\n# Modèles espace-état\n\nDans cette dernière partie nous estimons un modèle espace-état avec coefficients qui varient dans le temps.\n\nPour rappel, puisque nous avons 6 variables exogènes, le modèle s'écrit :\n\n$$\n\\begin{cases}\ny_t=X_t\\alpha_t+\\varepsilon_t,\\quad&\\varepsilon_t\\sim\\mathcal N(0,\\sigma^2)\\\\\n\\alpha_{t+1}=\\alpha_t+\\eta_t,\\quad&\\eta_t\\sim\\mathcal N(0,\\sigma^2 Q)\n\\end{cases},\\text{ avec }\\eta_t\\text{ et }\\varepsilon_t\\text{ indépendants et }\nQ = \\begin{pmatrix}q_1 &  &0 \\\\ & \\ddots \\\\ 0 & & q_6 \\end{pmatrix}\n$$\n\nLa matrice $Q$ peut-être imposée par l'utilisateur (par exemple variance nulle si l'on veut fixer tous les coefficients) ou estimée.\n\nIl y a également deux opérations classiques : \n\n- *smoothing* : estimation de $\\hat\\alpha_t=E[\\alpha_t|y]$ et $V_t=V[\\alpha_t-\\hat\\alpha_t]=V[\\alpha_t|y]$ : coefficients et variances estimés en utilisant l'ensemble des données disponibles ;\n\n- *filtering* : estimation de $a_{t+1}=E[\\alpha_{t+1}|Y_t]$ et $P_{t+1}=V[\\alpha_{t+1}|Y_t]$ : coefficients et variances estimés de manière dynamique en utilisant l'information disponible jusqu'à la date précédente (estimation en temps-réel).\n\nPour estimer ces modèles nous utiliserons la fonction `tvCoef::ssm_lm()` dont le premier paramètre est un modèle de régression linéaire (le modèle `model_c5`).\n\n::: {.callout-note}\n## Exercice\n\nPar défaut, `tvCoef::ssm_lm()` estime le modèle en forçant $q_1=q_2=\\dots=q_6=0$.\nQuel modèle retrouve-t-on ?\nRegarder les résultats de cette fonction et interpréter les quantités de `\"smoothed_states\"`, `\"filtering_states\"`,`\"smoothed_stdev\"` (sauf dernière colonne). \n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\n\nLe modèle estimé est le modèle de régression linéaire !\n\nLa composante `smoothed_states` contient les coefficients du modèle de régression linéaire estimé en utilisant toutes les données.\nLa dernière colonne (`\"noise\"`) contient les résidus.\nLa composante `smoothed_stdev` contient les écart-types associés aux différents coefficients, la dernière colonne s'interprète de manière plus complexe et ne sera pas détaillée ici.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod_ssm <- ssm_lm(model_c5)\nsummary(model_c5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nTime series regression with \"ts\" data:\nStart = 1993(2), End = 2019(4)\n\nCall:\ndynlm(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + \n    insee_oscd_c5_m2 + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, \n    1), data = data)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-2.89722 -0.42523 -0.01178  0.49598  1.70036 \n\nCoefficients:\n                             Estimate Std. Error t value Pr(>|t|)    \n(Intercept)                -15.941850   2.969369  -5.369 5.08e-07 ***\noverhang_ipi1_c5             0.122222   0.024494   4.990 2.52e-06 ***\ninsee_bc_c5_m3               0.148905   0.026959   5.523 2.59e-07 ***\ninsee_oscd_c5_m2            -0.043472   0.014544  -2.989  0.00351 ** \ndiff(insee_tppre_c5_m3, 1)   0.037110   0.014126   2.627  0.00996 ** \ndiff(bdf_tuc_c5_m2, 1)       0.018458   0.008287   2.227  0.02814 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.788 on 101 degrees of freedom\nMultiple R-squared:  0.6587,\tAdjusted R-squared:  0.6418 \nF-statistic: 38.99 on 5 and 101 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\ntail(mod_ssm$smoothed_states, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       (Intercept) overhang_ipi1_c5 insee_bc_c5_m3 insee_oscd_c5_m2\n[105,]   -15.94185        0.1222215      0.1489051      -0.04347231\n[106,]   -15.94185        0.1222215      0.1489051      -0.04347231\n[107,]   -15.94185        0.1222215      0.1489051      -0.04347231\n       diff(insee_tppre_c5_m3, 1) diff(bdf_tuc_c5_m2, 1)      noise\n[105,]                 0.03710989             0.01845755  0.8987397\n[106,]                 0.03710989             0.01845755 -0.2066754\n[107,]                 0.03710989             0.01845755 -0.2024679\n```\n:::\n\n```{.r .cell-code}\ntail(mod_ssm$smoothed_stdev, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       (Intercept) overhang_ipi1_c5 insee_bc_c5_m3 insee_oscd_c5_m2\n[105,]    2.969369       0.02449432     0.02695896       0.01454367\n[106,]    2.969369       0.02449432     0.02695896       0.01454367\n[107,]    2.969369       0.02449432     0.02695896       0.01454367\n       diff(insee_tppre_c5_m3, 1) diff(bdf_tuc_c5_m2, 1)     noise\n[105,]                 0.01412646            0.008286736 0.1531623\n[106,]                 0.01412646            0.008286736 0.1278911\n[107,]                 0.01412646            0.008286736 0.1491448\n```\n:::\n:::\n\nLa composante `filtering_states` donne les estimations des coefficients en temps réel : la valeur à la date $t$ correspond aux estimations des coefficients en utilisant les données jusqu'en $t-1$.\nAinsi, en estimant le modèle jusqu'en 2010T1, les coefficients obtenus sont ceux de la composante `filtering_states` de 2010T2\\ :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(dynlm(\n  formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + insee_oscd_c5_m2\n  + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, 1),\n  data = window(data, end = 2010)\n))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nTime series regression with \"ts\" data:\nStart = 1993(2), End = 2010(1)\n\nCall:\ndynlm(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + \n    insee_oscd_c5_m2 + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, \n    1), data = window(data, end = 2010))\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-2.74106 -0.41709  0.00975  0.42044  1.77480 \n\nCoefficients:\n                            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)                -12.67832    4.07290  -3.113 0.002802 ** \noverhang_ipi1_c5             0.13517    0.03481   3.883 0.000253 ***\ninsee_bc_c5_m3               0.11776    0.03758   3.134 0.002635 ** \ninsee_oscd_c5_m2            -0.02609    0.02003  -1.302 0.197606    \ndiff(insee_tppre_c5_m3, 1)   0.04778    0.01753   2.726 0.008329 ** \ndiff(bdf_tuc_c5_m2, 1)       0.02106    0.01007   2.091 0.040603 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.822 on 62 degrees of freedom\nMultiple R-squared:  0.7234,\tAdjusted R-squared:  0.7011 \nF-statistic: 32.43 on 5 and 62 DF,  p-value: 4.302e-16\n```\n:::\n\n```{.r .cell-code}\nwindow(mod_ssm$filtering_states, start = 2010, end = c(2010,2))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n        (Intercept) overhang_ipi1_c5 insee_bc_c5_m3 insee_oscd_c5_m2\n2010 Q1   -12.93133        0.1338363      0.1201360      -0.02742855\n2010 Q2   -12.67832        0.1351715      0.1177635      -0.02609094\n        diff(insee_tppre_c5_m3, 1) diff(bdf_tuc_c5_m2, 1) noise\n2010 Q1                 0.04742629             0.02107594     0\n2010 Q2                 0.04777549             0.02106144     0\n```\n:::\n:::\n\n:::\n\n::: {.callout-note}\n## Exercice\n\nEstimer maintenant le modèle en utilisant les paramètres suivant :\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_ssm <- ssm_lm(model_c5,\n       var_intercept = 0.01, fixed_var_intercept = FALSE,\n       var_variables = 0.01, fixed_var_variables = FALSE)\n```\n:::\n\n\nLes paramètres `fixed_var_intercept = FALSE` et `fixed_var_variables = FALSE` permettent d'indiquer que les variances $q_1,\\dots, q_6$ seront estimées.\nLes paramètres `var_intercept` et `var_variables` n'auront généralement aucun impact sur les résultats (puisque dans notre cas les variances sont estimées), ils interviennent toutefois dans le processus algorithmique : les modifier permet dans certains cas d'éviter des erreurs d'optimisation.\n\nRegarder les coefficients `model_ssm$smoothed_states` : quelles sont les variables qui varient dans le temps ?\nÀ partir de `model_ssm$fitted`, comparer la qualité prédictive de ce modèle avec les précédents.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\n\nLes variables fixes sont la constante et les carnets de commandes globaux :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(model_ssm$smoothed_states[,-ncol(model_ssm$smoothed_states)])\n```\n\n::: {.cell-output-display}\n![](TP_files/figure-html/coef-ssm-1.png){width=672}\n:::\n:::\n\nOn peut également vérifier en regardant les variances $\\sigma^2q_i$ :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_ssm$parameters$parameters * model_ssm$parameters$scaling\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               (Intercept).var           overhang_ipi1_c5.var \n                  0.000000e+00                   6.770260e-04 \n            insee_bc_c5_m3.var           insee_oscd_c5_m2.var \n                  4.348269e-07                   0.000000e+00 \ndiff(insee_tppre_c5_m3, 1).var     diff(bdf_tuc_c5_m2, 1).var \n                  9.975859e-05                   2.956853e-05 \n                     noise.var \n                  3.451667e-01 \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nres_ssm_is <- y - model_ssm$fitted[,\"smoothed\"]\nres_ssm_oos <- y - model_ssm$fitted[,\"filtering\"]\nrmse_ssm <- c(IS = rmse(res_ssm_is), OOS = rmse(res_ssm_oos))\nrbind(rmse_lm, rmse_rm, rmse_rm2, rmse_tvlm, rmse_ssm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                 IS       OOS\nrmse_lm   0.7656267 0.9298085\nrmse_rm   0.6008502 1.5042050\nrmse_rm2  0.6364012 1.4565471\nrmse_tvlm 0.5601224 1.1195514\nrmse_ssm  0.5165990 0.7938357\n```\n:::\n\n```{.r .cell-code}\n# Après 2010\napply(window(ts.union(res_lm_oos, res_rm_oos, res_rm2_oos, res_tvlm_lastbw_oos, res_ssm_oos), start = 2010), 2, rmse)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         res_lm_oos          res_rm_oos         res_rm2_oos res_tvlm_lastbw_oos \n          0.7431644           0.9633194           0.7018949           0.7904943 \n        res_ssm_oos \n          0.7005741 \n```\n:::\n:::\n\n\nEn réalité, la composante *filtering* ne correspond pas exactement à de l'estimation en temps-réel car certains paramètres ne sont pas estimés de manière dynamique.\nPour avoir une vraie estimation en temps-réel, il faudrait réestimer le modèle à chaque date : on peut pour cela utiliser la fonction `ssm_lm_oos()`.\nPour que cette fonction marche, il faut parfois jouer sur les paramètres `var_intercept` et `var_variables`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_ssm_oos <- ssm_lm_oos(model_c5,\n       var_intercept = 0.01, fixed_var_intercept = FALSE,\n       var_variables = 0.01, fixed_var_variables = FALSE)\nres_ssm_oos <- y - model_ssm_oos$prevision\n\nrmse_ssm <- c(IS = rmse(res_ssm_is), OOS = rmse(res_ssm_oos))\nrbind(rmse_lm, rmse_rm, rmse_rm2, rmse_tvlm, rmse_ssm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                 IS       OOS\nrmse_lm   0.7656267 0.9298085\nrmse_rm   0.6008502 1.5042050\nrmse_rm2  0.6364012 1.4565471\nrmse_tvlm 0.5601224 1.1195514\nrmse_ssm  0.5165990 0.7576956\n```\n:::\n\n```{.r .cell-code}\napply(window(ts.union(res_lm_oos, res_rm_oos, res_rm2_oos, res_tvlm_lastbw_oos, res_ssm_oos), start = 2010), 2, rmse)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         res_lm_oos          res_rm_oos         res_rm2_oos res_tvlm_lastbw_oos \n          0.7431644           0.9633194           0.7018949           0.7904943 \n        res_ssm_oos \n          0.6838548 \n```\n:::\n:::\n\n\nOn peut enfin faire un graphique avec toutes les prévisions, en utilisant par exemple le package `dygraphs` :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dygraphs)\nprevs <- ts.intersect(y, y - res_lm_oos, y - res_rm2_oos, y - res_tvlm_lastbw_oos, y - res_ssm_oos)\ncolnames(prevs) <- c(\"y\", \"lm\", \"Reg par morceaux\", \"Reg locale\", \"SSM\")\ndygraph(prevs) %>% \n  dyRangeSelector(dateWindow = c(\"2010-01-01\", \"2019-12-01\")) %>%\n  dyOptions(colors = c(\"black\", \"red\", \"green\", \"blue\", \"purple\"))\n```\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"dygraphs html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-b53677a355f0bfa504c8\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-b53677a355f0bfa504c8\">{\"x\":{\"attrs\":{\"labels\":[\"quarter\",\"y\",\"lm\",\"Reg par morceaux\",\"Reg locale\",\"SSM\"],\"legend\":\"auto\",\"retainDateWindow\":false,\"axes\":{\"x\":{\"pixelsPerLabel\":60,\"drawAxis\":true},\"y\":{\"drawAxis\":true}},\"showRangeSelector\":true,\"dateWindow\":[\"2010-01-01T00:00:00.000Z\",\"2019-12-01T00:00:00.000Z\"],\"rangeSelectorHeight\":40,\"rangeSelectorPlotFillColor\":\" #A7B1C4\",\"rangeSelectorPlotStrokeColor\":\"#808FAB\",\"interactionModel\":\"Dygraph.Interaction.defaultModel\",\"stackedGraph\":false,\"fillGraph\":false,\"fillAlpha\":0.15,\"stepPlot\":false,\"drawPoints\":false,\"pointSize\":1,\"drawGapEdgePoints\":false,\"connectSeparatedPoints\":false,\"strokeWidth\":1,\"strokeBorderColor\":\"white\",\"colors\":[\"black\",\"red\",\"green\",\"blue\",\"purple\"],\"colorValue\":0.5,\"colorSaturation\":1,\"includeZero\":false,\"drawAxesAtZero\":false,\"logscale\":false,\"axisTickSize\":3,\"axisLineColor\":\"black\",\"axisLineWidth\":0.3,\"axisLabelColor\":\"black\",\"axisLabelFontSize\":14,\"axisLabelWidth\":60,\"drawGrid\":true,\"gridLineWidth\":0.3,\"rightGap\":5,\"digitsAfterDecimal\":2,\"labelsKMB\":false,\"labelsKMG2\":false,\"labelsUTC\":false,\"maxNumberWidth\":6,\"animatedZooms\":false,\"mobileDisableYTouch\":true,\"disableZoom\":false},\"scale\":\"quarterly\",\"annotations\":[],\"shadings\":[],\"events\":[],\"format\":\"date\",\"data\":[[\"2000-04-01T00:00:00.000Z\",\"2000-07-01T00:00:00.000Z\",\"2000-10-01T00:00:00.000Z\",\"2001-01-01T00:00:00.000Z\",\"2001-04-01T00:00:00.000Z\",\"2001-07-01T00:00:00.000Z\",\"2001-10-01T00:00:00.000Z\",\"2002-01-01T00:00:00.000Z\",\"2002-04-01T00:00:00.000Z\",\"2002-07-01T00:00:00.000Z\",\"2002-10-01T00:00:00.000Z\",\"2003-01-01T00:00:00.000Z\",\"2003-04-01T00:00:00.000Z\",\"2003-07-01T00:00:00.000Z\",\"2003-10-01T00:00:00.000Z\",\"2004-01-01T00:00:00.000Z\",\"2004-04-01T00:00:00.000Z\",\"2004-07-01T00:00:00.000Z\",\"2004-10-01T00:00:00.000Z\",\"2005-01-01T00:00:00.000Z\",\"2005-04-01T00:00:00.000Z\",\"2005-07-01T00:00:00.000Z\",\"2005-10-01T00:00:00.000Z\",\"2006-01-01T00:00:00.000Z\",\"2006-04-01T00:00:00.000Z\",\"2006-07-01T00:00:00.000Z\",\"2006-10-01T00:00:00.000Z\",\"2007-01-01T00:00:00.000Z\",\"2007-04-01T00:00:00.000Z\",\"2007-07-01T00:00:00.000Z\",\"2007-10-01T00:00:00.000Z\",\"2008-01-01T00:00:00.000Z\",\"2008-04-01T00:00:00.000Z\",\"2008-07-01T00:00:00.000Z\",\"2008-10-01T00:00:00.000Z\",\"2009-01-01T00:00:00.000Z\",\"2009-04-01T00:00:00.000Z\",\"2009-07-01T00:00:00.000Z\",\"2009-10-01T00:00:00.000Z\",\"2010-01-01T00:00:00.000Z\",\"2010-04-01T00:00:00.000Z\",\"2010-07-01T00:00:00.000Z\",\"2010-10-01T00:00:00.000Z\",\"2011-01-01T00:00:00.000Z\",\"2011-04-01T00:00:00.000Z\",\"2011-07-01T00:00:00.000Z\",\"2011-10-01T00:00:00.000Z\",\"2012-01-01T00:00:00.000Z\",\"2012-04-01T00:00:00.000Z\",\"2012-07-01T00:00:00.000Z\",\"2012-10-01T00:00:00.000Z\",\"2013-01-01T00:00:00.000Z\",\"2013-04-01T00:00:00.000Z\",\"2013-07-01T00:00:00.000Z\",\"2013-10-01T00:00:00.000Z\",\"2014-01-01T00:00:00.000Z\",\"2014-04-01T00:00:00.000Z\",\"2014-07-01T00:00:00.000Z\",\"2014-10-01T00:00:00.000Z\",\"2015-01-01T00:00:00.000Z\",\"2015-04-01T00:00:00.000Z\",\"2015-07-01T00:00:00.000Z\",\"2015-10-01T00:00:00.000Z\",\"2016-01-01T00:00:00.000Z\",\"2016-04-01T00:00:00.000Z\",\"2016-07-01T00:00:00.000Z\",\"2016-10-01T00:00:00.000Z\",\"2017-01-01T00:00:00.000Z\",\"2017-04-01T00:00:00.000Z\",\"2017-07-01T00:00:00.000Z\",\"2017-10-01T00:00:00.000Z\",\"2018-01-01T00:00:00.000Z\",\"2018-04-01T00:00:00.000Z\",\"2018-07-01T00:00:00.000Z\",\"2018-10-01T00:00:00.000Z\",\"2019-01-01T00:00:00.000Z\",\"2019-04-01T00:00:00.000Z\",\"2019-07-01T00:00:00.000Z\",\"2019-10-01T00:00:00.000Z\"],[1.41586211509732,0.774997801424671,1.58934473618186,0.155696338451627,-0.592870544090052,0.226483466706928,-2.11982955279129,0.963039511004604,-0.102354145342887,-0.235437739797695,-0.872956909361067,-0.301998258550185,-1.04692941241501,0.384323188988689,0.0957129501847565,1.14523338299717,-0.213261806349485,-0.565139797739445,0.270327162340323,0.480636428926573,-0.30899494171982,0.956330866212962,0.882809256386174,0.233933329001235,1.80334954078876,-0.00742949935788051,1.26204729758417,0.271485623840428,0.560317792180642,0.515613954842187,-0.216150250279235,0.916223583429199,-2.14857189807635,-1.05589084229861,-5.8173949018235,-6.42225601171369,-0.176931502232702,1.78330278769172,0.964283598886451,-0.167783266259136,1.69005476811697,0.509685174055763,1.02110044270685,2.64191319590681,-0.567791159314213,-0.544266244339853,-0.818624262677459,-0.835556962597805,-1.0865971153298,0.591340833640719,-2.15206554747035,-0.0667548924309314,0.474627915152936,-0.726657724383273,0.528715104803079,0.399710151702859,-0.221177127956784,0.312667708892356,-0.331464725175035,0.291725497975426,0.468893620487054,0.274464389114071,0.779562751914264,-0.0882400128349059,-0.662958077650977,1.02301199672081,-0.117723703610573,0.810161345691718,1.08515516810825,0.854537696229252,1.28931692924346,-1.72138986292636,1.05696421980381,0.375199220825206,-0.348435897718624,0.648409405255879,0.247358758149097,-0.312547978856403,-0.707362955303026],[1.94755141898527,1.73422528752702,1.37616471032235,0.254996276690519,-0.246677138937018,-1.09793050571945,-0.492578216193497,0.431087825025634,0.772219054049658,-0.663618810391756,-0.330645671389756,-0.791122488118662,-0.745953604667876,-0.0359228885525847,0.200433712061047,0.224438712729141,0.185503148704833,0.780686122098162,0.478004919784415,-0.115981918951176,-0.292201099777837,-0.17467232516241,0.541615678207942,0.433367068567272,0.221407239589946,0.440042263357301,0.779506963647463,0.591942200995068,0.56389272622375,0.592604832656598,0.77555342400597,0.639021203498906,-0.690137011727574,-1.07333628721344,-3.07537399824855,-3.48142903772387,-1.74917648818361,-0.54782416475963,-0.886811714239244,-0.0222237033869914,0.405931928280361,0.296636765454698,0.713994967444365,0.977973468543658,0.388084550864051,-1.50952136335872,-0.657878644332294,-0.45042661988344,-1.3978542711124,-0.584376031749234,-1.1173891308148,-0.455285702537204,-0.222835632630649,-0.365435439691972,-0.141803716121738,0.0689362418957251,-0.482696709351492,-0.123201124421287,-0.209338546104338,0.319218155602497,-0.191620640963533,0.26127619475721,-0.0825543149146388,0.374824974364394,0.0969045657585648,-0.203278424875786,0.485605901242028,-0.148250018675063,0.962296779133616,0.684495648208485,0.960796206130379,-0.0966784231119773,-0.380260087783288,0.171534693606004,-0.0658474155172408,-0.161284206178646,-0.679809763824402,-0.095457383359609,-0.497373319917707],[1.94755141898527,1.73422528752702,1.37616471032235,0.254996276690526,-0.24667713893702,-1.09793050571946,-0.4925782161935,0.431087825025629,0.772219054049656,-0.663618810391756,-0.330645671389759,-0.791122488118663,-0.745953604667882,-0.0359228885525835,0.200433712061047,0.224438712729141,0.185503148704833,0.780686122098157,0.478004919784416,-0.115981918951176,-0.29220109977784,-0.174672325162411,0.541615678207939,0.433367068567272,0.221407239589947,0.440042263357302,0.779506963647462,0.591942200995062,0.563892726223751,0.5926048326566,0.775553424005967,0.639021203498907,-0.690137011727572,-1.07333628721344,4.78869923143843,-5.19926167882638,-3.81167188318731,0.573120113383451,0.238806663258004,0.277655041353571,1.44681050671245,2.04827200504972,0.686808303485731,3.07077603910271,-0.777380094937548,-1.33453061311186,-0.93782876088464,-1.63714997372317,-1.19700463715115,-0.0315435601202936,-2.31105657015221,0.40025819870958,0.840397362122367,-0.784448766480773,0.248957366678811,-1.06937146411826,0.081053894792915,0.50225927837903,-0.838265154810562,0.901674831687053,0.0438027726014673,-0.255079737737064,-0.339609730822587,1.34897554870549,-0.058305769063877,0.022221351530513,-0.439778115315923,-0.157369306021255,1.46255495523252,1.13647241897067,2.04750737743798,-1.17445044813651,0.675246508088023,0.342125097867305,0.561312301203492,0.180680539889758,-0.567014555648478,0.0699131675842248,0.842585193332272],[2.35143102075651,-0.911623994016276,1.57436378822881,-0.485914047728637,-1.98751739112068,-0.501951149160801,1.09241313425109,-0.400432404017966,-0.0548194949724067,-3.54899912949212,-0.851526800221034,-0.493232804209186,-0.215370507078353,-0.994590107737747,0.392693452230771,-0.340159180635187,0.162322469440055,0.618547238991867,-0.0173850032431949,0.776232144787706,0.701187629322888,-0.315094870855135,1.38936534133281,-0.0542304995038755,0.876107063426866,1.49485905099384,0.417273968924164,0.800387003673299,0.916748067264495,-0.301484882618913,0.457422412858631,1.21685152112832,-0.715819315692021,-0.461549138199587,-4.54283842650104,-4.13357814401372,-4.60429511955352,1.22232001992385,0.870091156924388,0.0437532021532778,0.182081934884352,1.52213512067248,0.283960248412209,1.86418099772478,-0.846715914018536,-2.41380970026913,-0.926673665022203,-1.17854547417432,-1.52304728411648,-0.169316322084897,-1.98106437546427,0.345694531493438,0.779925549867299,-0.239759666207477,0.296415736589983,-1.1359683333129,0.0396256643781161,0.336862132594938,-0.410081919758438,0.793968396825892,0.105699081984043,0.0860633276841223,0.143340651381122,1.20013342620175,-0.157063069942564,0.0295786179602606,0.213103795235385,0.199599593467738,1.05915899800136,0.849595083792179,1.60369764528579,0.379614433260415,0.786143038271409,-0.484261321252098,0.639351161842652,0.275094729264203,-0.244203348615899,0.0113410782841336,0.713317025930038],[1.98979882277973,1.35538516223411,1.32433329134636,0.0672513336216543,-0.691026332842418,-0.921983770944892,-0.303021648740713,0.382880544947518,0.740264166900343,-0.801172689809113,-0.495833099848269,-0.831459451328818,-0.77474155514957,-0.0168072585781767,0.292239190724659,0.175613122494156,0.118495352500674,0.732304550940743,0.411777643923912,-0.0178954544576304,-0.255097433964327,-0.300074020852242,0.498226394539347,0.332221580614521,0.338495374686213,0.538158320271909,0.895754686326222,0.62951823327501,0.617268347502848,0.5044842530816,0.624149294932749,0.854065200586872,-1.29519145158935,-0.80170759202568,-4.20798196491505,-4.2435504712064,-1.28867187168701,0.704050766559277,0.242903079176499,-0.129220554928108,0.427804710296164,0.91604997817249,0.486077227608319,1.76787036294669,-0.896646051387843,-2.24640882856832,-0.838942611606468,-1.26720642905264,-1.25021227119585,0.0322005569690608,-1.88016923533287,0.413549089300427,0.684150438801492,-0.700402439059565,0.236855111374155,-0.832136282998556,0.0712274499443103,0.516267087927257,-0.593283497932134,0.840437985162887,0.0343499390264507,0.00144365879960345,-0.142710449927288,1.19849962890267,-0.0577254998507133,0.132090914656283,-0.24629203653431,0.137168568162909,1.13561480082676,0.871583031548468,1.52114626480825,-0.287592546103022,0.771064475084322,-0.0240835062854422,0.564572130103209,0.142707257634056,-0.356672144967582,-0.0628262946359741,0.575989946312545]],\"fixedtz\":false,\"tzone\":\"\"},\"evals\":[\"attrs.interactionModel\"],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n:::\n\n\n::: {.callout-note}\n## Exercice facultatif\n\nL'objectif de cet exercice est d'estimer un nouveau modèle jusqu'en 2022T4 pour faire une prévision jusqu'en 2023T1 :\n\n1. Créer des indicatrices sur les 4 premiers trimestres de l'année 2020.\n\n2. Estimer un nouveau modèle `dynlm` en ajoutant ces indicatrices.\n\n3. Estimer un nouveau modèle espace-état.\n\n4. Utiliser les variables exogènes du modèles jusqu'en 2023T1 (on peut pour cela appliquer la fonction `tvCoef::full_exogeneous_matrix()` sur le modèle `dynlm`) et la dernière ligne de la composante `\"smoothed_states\"` pour effectuer des prévisions sur 2023T1.\n\n:::: {.callout-important}\n## Attention\n\nAu moment de la rédaction du TP, toutes les données du 2023T1 ne sont pas disponibles, la prévision ne peut donc pas être faite jusqu'à cette date.\nToutefois, cet exercice vous permet de voir comment procéder lorsque ces données seront disponibles.\nCe TP sera mis à jour le 28 mars avec les nouvelles données.\n:::\n::::\n\n::: {.callout-caution collapse=\"true\"}\n## Indice (création des indicatrices)\n\nOn pourra utiliser le programme suivant pour créer les indicatrices :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nind <- cbind(time(manufacturing) == 2020, time(manufacturing) == 2020.25, time(manufacturing) == 2020.5,\ntime(manufacturing) == 2020.75)\nind <- ts(apply(ind,2, as.numeric), start = start(manufacturing), frequency = 4)\ncolnames(ind) <- sprintf(\"ind2020Q%i\", 1:4)\ndata <- ts.union(manufacturing, ind)\ncolnames(data) <- c(colnames(manufacturing), colnames(ind))\n```\n:::\n\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\n\nEstimation du modèle de régression linéaire :\n\n::: {.cell}\n\n```{.r .cell-code}\nind <- cbind(time(manufacturing) == 2020, time(manufacturing) == 2020.25, time(manufacturing) == 2020.5,\ntime(manufacturing) == 2020.75)\nind <- ts(apply(ind,2, as.numeric), start = start(manufacturing), frequency = 4)\ncolnames(ind) <- sprintf(\"ind2020Q%i\", 1:4)\ndata <- ts.union(manufacturing, ind)\ncolnames(data) <- c(colnames(manufacturing), colnames(ind))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- ts.union(manufacturing, ind)\ncolnames(data) <- c(colnames(manufacturing), colnames(ind))\nmodel_c5_complet <- dynlm(\n  formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + insee_oscd_c5_m2\n  + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, 1) \n  + ind2020Q1 + ind2020Q2 + ind2020Q3 + ind2020Q4,\n  data = data\n)\nsummary(model_c5_complet)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nTime series regression with \"ts\" data:\nStart = 1990(2), End = 2022(4)\n\nCall:\ndynlm(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + \n    insee_oscd_c5_m2 + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, \n    1) + ind2020Q1 + ind2020Q2 + ind2020Q3 + ind2020Q4, data = data)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-3.0369 -0.3704  0.0000  0.4409  1.8337 \n\nCoefficients:\n                            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)                -15.32223    2.84160  -5.392 3.50e-07 ***\noverhang_ipi1_c5             0.13436    0.02188   6.141 1.08e-08 ***\ninsee_bc_c5_m3               0.14237    0.02581   5.516 2.00e-07 ***\ninsee_oscd_c5_m2            -0.04236    0.01389  -3.048  0.00283 ** \ndiff(insee_tppre_c5_m3, 1)   0.02288    0.01295   1.767  0.07973 .  \ndiff(bdf_tuc_c5_m2, 1)       0.01797    0.00807   2.227  0.02780 *  \nind2020Q1                   -5.02746    0.84001  -5.985 2.27e-08 ***\nind2020Q2                  -13.43482    1.18843 -11.305  < 2e-16 ***\nind2020Q3                   21.85700    0.96497  22.651  < 2e-16 ***\nind2020Q4                    2.65855    0.84700   3.139  0.00213 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.8198 on 121 degrees of freedom\n  (131 observations effacées parce que manquantes)\nMultiple R-squared:  0.9313,\tAdjusted R-squared:  0.9262 \nF-statistic: 182.3 on 9 and 121 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\nprev_oos_lm_complet <- oos_prev(model_c5_complet)\n```\n:::\n\n\nEstimation du modèle espace-état :\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_ssm_complet <- ssm_lm(model_c5_complet,\n       var_intercept = 0.01, fixed_var_intercept = FALSE,\n       var_variables = 0.01, fixed_var_variables = FALSE)\n# # Rmq : on pourrait également fixer à 0 les variances des coefficients associées aux indicatrices :\n# model_ssm_complet <- ssm_lm(model_c5_complet,\n#         var_intercept = 0.01, fixed_var_intercept = FALSE,\n#         var_variables = c(rep(0.01,5), rep(0, 4)), \n#         fixed_var_variables = c(rep(FALSE,5), rep(TRUE, 4)))\n\nmodel_ssm_complet_oos <- ssm_lm_oos(model_c5_complet, date = 18*4,\n       var_intercept = 0.01, fixed_var_intercept = FALSE,\n       var_variables = 0.01, fixed_var_variables = FALSE)\n```\n:::\n\n\nComme vous allez le voir, les soldes d'opinion de l'Insee de mars ne sont pas encore disponibles au moment de l'écriture du TP : la prévisions de 2023T1 ne peut donc pas être calculé.\nToutefois, ce code reste valide si vous utilisez un autre modèle où les données sont disponibles.\nPar ailleurs, ce TP sera mis à jour au moment de la publication de ces soldes d'opinion.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nX_variables = full_exogeneous_matrix(model_c5_complet)\n# Comme vous voyez ici, les soldes d'opinion de l'Insee de mars ne sont pas encore disponibles au moment de l'écrit\nwindow(X_variables, start = 2022)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n        (Intercept) overhang_ipi1_c5 insee_bc_c5_m3 insee_oscd_c5_m2\n2022 Q1           1         7.629539          108.0              4.5\n2022 Q2           1         2.870669          105.8             -2.2\n2022 Q3           1         2.663170           97.9            -16.0\n2022 Q4           1         1.979440           96.2            -24.6\n2023 Q1           1         1.737138             NA            -23.7\n        diff(insee_tppre_c5_m3, 1) diff(bdf_tuc_c5_m2, 1) ind2020Q1 ind2020Q2\n2022 Q1                      -20.1                   0.38         0         0\n2022 Q2                        0.1                  -3.20         0         0\n2022 Q3                       -9.7                  -0.35         0         0\n2022 Q4                       10.1                   3.97         0         0\n2023 Q1                         NA                     NA         0         0\n        ind2020Q3 ind2020Q4\n2022 Q1         0         0\n2022 Q2         0         0\n2022 Q3         0         0\n2022 Q4         0         0\n2023 Q1         0         0\n```\n:::\n\n```{.r .cell-code}\nprevs_lm <- rowSums(X_variables %*% diag(coef(model_c5_complet)))\nprevs_lm <- prevs_lm[length(prevs_lm)]\nprevs_ssm <- rowSums(X_variables %*% diag(model_ssm_complet$smoothed_states[nrow(model_ssm_complet$smoothed_states), - ncol(model_ssm_complet$smoothed_states)]))\nprevs_ssm <- prevs_ssm[length(prevs_ssm)]\nfull_prevs <- ts.union(prev_oos_lm_complet$prevision,\n                       model_ssm_complet_oos$prevision)\nfull_prevs <- ts(rbind(full_prevs,\n                       c(prevs_lm, prevs_ssm)),\n                 start = start(full_prevs),\n                 frequency = frequency(full_prevs))\ndata_forecasts <- ts.union(manufacturing[,\"prod_c5\"], full_prevs)\ndata_forecasts <- window(data_forecasts, start = 2010)\ncolnames(data_forecasts) <- c(\"y\", \"lm\", \"SSM\")\ndygraph(data_forecasts) %>% \n  dyRangeSelector(dateWindow = c(\"2018-01-01\", \"2023-03-01\"))\n```\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"dygraphs html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-95900e17eb14a4127654\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-95900e17eb14a4127654\">{\"x\":{\"attrs\":{\"labels\":[\"quarter\",\"y\",\"lm\",\"SSM\"],\"legend\":\"auto\",\"retainDateWindow\":false,\"axes\":{\"x\":{\"pixelsPerLabel\":60}},\"showRangeSelector\":true,\"dateWindow\":[\"2018-01-01T00:00:00.000Z\",\"2023-03-01T00:00:00.000Z\"],\"rangeSelectorHeight\":40,\"rangeSelectorPlotFillColor\":\" #A7B1C4\",\"rangeSelectorPlotStrokeColor\":\"#808FAB\",\"interactionModel\":\"Dygraph.Interaction.defaultModel\"},\"scale\":\"quarterly\",\"annotations\":[],\"shadings\":[],\"events\":[],\"format\":\"date\",\"data\":[[\"2010-01-01T00:00:00.000Z\",\"2010-04-01T00:00:00.000Z\",\"2010-07-01T00:00:00.000Z\",\"2010-10-01T00:00:00.000Z\",\"2011-01-01T00:00:00.000Z\",\"2011-04-01T00:00:00.000Z\",\"2011-07-01T00:00:00.000Z\",\"2011-10-01T00:00:00.000Z\",\"2012-01-01T00:00:00.000Z\",\"2012-04-01T00:00:00.000Z\",\"2012-07-01T00:00:00.000Z\",\"2012-10-01T00:00:00.000Z\",\"2013-01-01T00:00:00.000Z\",\"2013-04-01T00:00:00.000Z\",\"2013-07-01T00:00:00.000Z\",\"2013-10-01T00:00:00.000Z\",\"2014-01-01T00:00:00.000Z\",\"2014-04-01T00:00:00.000Z\",\"2014-07-01T00:00:00.000Z\",\"2014-10-01T00:00:00.000Z\",\"2015-01-01T00:00:00.000Z\",\"2015-04-01T00:00:00.000Z\",\"2015-07-01T00:00:00.000Z\",\"2015-10-01T00:00:00.000Z\",\"2016-01-01T00:00:00.000Z\",\"2016-04-01T00:00:00.000Z\",\"2016-07-01T00:00:00.000Z\",\"2016-10-01T00:00:00.000Z\",\"2017-01-01T00:00:00.000Z\",\"2017-04-01T00:00:00.000Z\",\"2017-07-01T00:00:00.000Z\",\"2017-10-01T00:00:00.000Z\",\"2018-01-01T00:00:00.000Z\",\"2018-04-01T00:00:00.000Z\",\"2018-07-01T00:00:00.000Z\",\"2018-10-01T00:00:00.000Z\",\"2019-01-01T00:00:00.000Z\",\"2019-04-01T00:00:00.000Z\",\"2019-07-01T00:00:00.000Z\",\"2019-10-01T00:00:00.000Z\",\"2020-01-01T00:00:00.000Z\",\"2020-04-01T00:00:00.000Z\",\"2020-07-01T00:00:00.000Z\",\"2020-10-01T00:00:00.000Z\",\"2021-01-01T00:00:00.000Z\",\"2021-04-01T00:00:00.000Z\",\"2021-07-01T00:00:00.000Z\",\"2021-10-01T00:00:00.000Z\",\"2022-01-01T00:00:00.000Z\",\"2022-04-01T00:00:00.000Z\",\"2022-07-01T00:00:00.000Z\",\"2022-10-01T00:00:00.000Z\",\"2023-01-01T00:00:00.000Z\"],[-0.167783266259136,1.69005476811697,0.509685174055763,1.02110044270685,2.64191319590681,-0.567791159314213,-0.544266244339853,-0.818624262677459,-0.835556962597805,-1.0865971153298,0.591340833640719,-2.15206554747035,-0.0667548924309314,0.474627915152936,-0.726657724383273,0.528715104803079,0.399710151702859,-0.221177127956784,0.312667708892356,-0.331464725175035,0.291725497975426,0.468893620487054,0.274464389114071,0.779562751914264,-0.0882400128349059,-0.662958077650977,1.02301199672081,-0.117723703610573,0.810161345691718,1.08515516810825,0.854537696229252,1.28931692924346,-1.72138986292636,1.05696421980381,0.375199220825206,-0.348435897718624,0.648409405255879,0.247358758149097,-0.312547978856403,-0.707362955303026,-5.95847459504975,-18.6416116870877,24.2741503395746,3.89186669773947,0.280394795872585,-0.518957611005477,-0.54977177163672,-0.461241054975869,1.70018966711718,-0.302637750429946,-0.305796695603477,-0.38201388732837,null],[-0.285131012963285,0.294176444871434,0.146247272920124,0.530413103342053,0.951601422444633,0.143594259766169,-1.41780794439257,-0.718750967694256,-0.477083663136255,-1.36744384687437,-0.634723667928581,-1.16112441366732,-0.514199523951678,-0.255773413340787,-0.329456929063504,-0.243691034763245,-0.0481438332498072,-0.486726194331041,-0.130795751046643,-0.230152596682773,0.215249827142423,-0.214768757200362,0.196409184907548,-0.174700017956703,0.335988013579408,0.0471551844127069,-0.192671705032358,0.339071832509344,-0.173907760421184,0.946017270360565,0.687954969368935,0.912879271643145,-0.106673151745162,-0.26289088349506,0.162460214718729,-0.0272176597122662,-0.156897756149063,-0.654286861548352,-0.0669394169383846,-0.390798097393705,-1.0441787782346,-4.80121604914978,2.27540636803925,1.20692733593601,0.952730545373821,1.24903434276838,1.51117770869571,1.00807848098337,0.254368544829909,0.179734078916332,-0.585520209657327,-0.00122990449629057,null],[-0.168521202446689,0.457376951759377,0.821205159976189,0.505643732671853,1.75456372052681,-0.87233278028428,-2.2295398029819,-0.762499909279015,-1.19954572312388,-1.25876772356998,-0.0103391204775634,-1.87047955070037,0.395221446750683,0.669143785554234,-0.681735261448156,0.250797210449291,-0.831247569488232,0.0793693114196421,0.554268177828352,-0.595480221762142,0.865836832455889,0.033037451555268,0.0129694708627766,-0.165523295373188,1.19329925425909,-0.0124898481258164,0.117595474068913,-0.227253954720743,0.163016026959875,1.13264498311443,0.893472330305014,1.56747477491725,-0.25988589943692,0.78025881494476,0.0292815609190484,0.555755861105386,0.138917195224456,-0.337443610555407,-0.0581141006318268,0.58454237030369,0.302956172596338,-13.3470784672341,6.37518726718223,2.59578099806918,2.4986290269326,0.627553055280822,0.212736488856238,0.324364198195629,0.465183564767132,-0.292870578675512,-0.00639995641406244,-1.30215177373596,null]]},\"evals\":[\"attrs.interactionModel\"],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n:::\n\n\n\n\n\n",
    "supporting": [
      "TP_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/htmlwidgets-1.6.1/htmlwidgets.js\"></script>\r\n<script src=\"site_libs/jquery-1.11.1/jquery.min.js\"></script>\r\n<link href=\"site_libs/dygraphs-1.1.1/dygraph.css\" rel=\"stylesheet\" />\r\n<script src=\"site_libs/dygraphs-1.1.1/dygraph-combined.js\"></script>\r\n<script src=\"site_libs/dygraphs-1.1.1/shapes.js\"></script>\r\n<script src=\"site_libs/moment-2.8.4/moment.js\"></script>\r\n<script src=\"site_libs/moment-timezone-0.2.5/moment-timezone-with-data.js\"></script>\r\n<script src=\"site_libs/moment-fquarter-1.0.0/moment-fquarter.min.js\"></script>\r\n<script src=\"site_libs/dygraphs-binding-1.1.1.6/dygraphs.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}