<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Claire du Campe de Rosamel">
<meta name="author" content="Alain Quartier-la-Tente">

<title>Atelier tvCoef - Utilisation de modèles de régression à coefficients variant dans le temps pour la prévision conjoncturelle</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "Pas de résultats",
    "search-matching-documents-text": "documents trouvés",
    "search-copy-link-title": "Copier le lien vers la recherche",
    "search-hide-matches-text": "Cacher les correspondances additionnelles",
    "search-more-match-text": "correspondance de plus dans ce document",
    "search-more-matches-text": "correspondances de plus dans ce document",
    "search-clear-button-title": "Effacer",
    "search-detached-cancel-button-title": "Annuler",
    "search-submit-button-title": "Envoyer"
  }
}</script>
<script src="site_libs/htmlwidgets-1.6.1/htmlwidgets.js"></script>
<script src="site_libs/jquery-1.11.1/jquery.min.js"></script>
<link href="site_libs/dygraphs-1.1.1/dygraph.css" rel="stylesheet">
<script src="site_libs/dygraphs-1.1.1/dygraph-combined.js"></script>
<script src="site_libs/dygraphs-1.1.1/shapes.js"></script>
<script src="site_libs/moment-2.8.4/moment.js"></script>
<script src="site_libs/moment-timezone-0.2.5/moment-timezone-with-data.js"></script>
<script src="site_libs/moment-fquarter-1.0.0/moment-fquarter.min.js"></script>
<script src="site_libs/dygraphs-binding-1.1.1.6/dygraphs.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="css/callout.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Atelier tvCoef</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./slides.html">
 <span class="menu-text">Slides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./manuel_installation.html">
 <span class="menu-text">Manuel d’installation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./TP.html" aria-current="page">
 <span class="menu-text">TP</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sur cette page</h2>
   
  <ul>
  <li><a href="#régression-par-morceaux" id="toc-régression-par-morceaux" class="nav-link active" data-scroll-target="#régression-par-morceaux"><span class="toc-section-number">1</span>  Régression par morceaux</a></li>
  <li><a href="#régression-locale" id="toc-régression-locale" class="nav-link" data-scroll-target="#régression-locale"><span class="toc-section-number">2</span>  Régression locale</a></li>
  <li><a href="#modèles-espace-état" id="toc-modèles-espace-état" class="nav-link" data-scroll-target="#modèles-espace-état"><span class="toc-section-number">3</span>  Modèles espace-état</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Utilisation de modèles de régression à coefficients variant dans le temps pour la prévision conjoncturelle</h1>
<p class="subtitle lead">Atelier D2E</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Auteurs</div>
    <div class="quarto-title-meta-contents">
             <p>Claire du Campe de Rosamel </p>
             <p>Alain Quartier-la-Tente </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Date</div>
    <div class="quarto-title-meta-contents">
      <p class="date">16 mars 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<blockquote class="blockquote">
<p>L’objectif de ce TP est d’apprendre à utiliser quelques fonctionnalités du package <code>tvCoef</code> pour l’estimation de modèles de régression à coefficients variant dans le temps.</p>
</blockquote>
<p>Les packages suivants seront utilisés :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>packages_to_install <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"dygraphs"</span>, <span class="st">"car"</span>, <span class="st">"dynlm"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">installed.packages</span>()[,<span class="st">"Package"</span>][<span class="sc">!</span> packages_to_install <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="st">"Package"</span>]]</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(packages) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(packages)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"tvCoef"</span> <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="st">"Package"</span>]) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"palatej/rjd3toolkit"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"palatej/rjd3sts"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"AQLT/tvCoef"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pour l’installation de tvCoef, voir le <a href="./manuel_installation.html">manuel d’installation</a>. Si vous utiliser le <a href="https://datalab.ssp.cloud.fr" class="uri">https://datalab.ssp.cloud.fr</a>, créer une instance en cliquant ici : <a href="https://datalab.sspcloud.fr/launcher/ide/rstudio?autoLaunch=true&amp;service.image.custom.enabled=true&amp;service.image.pullPolicy=%C2%ABAlways%C2%BB&amp;service.image.custom.version=%C2%ABaqlt%2Fatelier-tvcoef%3Alatest%C2%BB"><img src="https://img.shields.io/badge/Launch-Datalab-orange?logo=R.png" class="img-fluid" alt="Onyxia"></a>.</p>
<p>Pour ce TP nous utiliserons les données de la base <code>tvCoef::manufacturing</code>pour prévoir l’évolution trimestrielle de la production du secteur des autres industries manufacturières (C5, <code>prod_c5</code>) à partir de :</p>
<ul>
<li><p>l’acquis de croissance au premier mois du trimestre de l’indice de production industrielle du même secteur (<code>overhang_ipi1_c5</code>) ;</p></li>
<li><p>des soldes d’opinion de l’Insee et de la Banque de France. Ces soldes d’opinion sont trimestrialisés en prenant la place du mois dans le trimestre&nbsp;:</p>
<ul>
<li><p><code>insee_bc_c5_m3</code> : climat des affaires au 3<sup>e</sup> mois du trimestre (mars, juin, septembre, décembre)</p></li>
<li><p><code>insee_oscd_c5_m2</code> : niveau des carnets de commandes au 2<sup>e</sup> mois du trimestre (février, mai, septembre, novembre)</p></li>
<li><p><code>insee_tppre_c5_m3</code> : solde d’opinion sur l’évolution future de la production au 3<sup>e</sup> mois du trimestre (février, mai, septembre, novembre).</p></li>
<li><p><code>bdf_tuc_c5_m2</code> : taux d’utilisation des capacités de production au deuxième mois du trimestre (février, mai, septembre, novembre).</p></li>
</ul></li>
</ul>
<p>Les deux dernières variables sont utilisées en différence.</p>
<p>Par simplification, nous estimerons ici le modèle entre le 1993T1 et 2019T4 : pour estimer le modèle au-delà cette date, il faudrait ajouter des indicatrices au cours de l’année 2020 et vérifier si le modèle estimé est toujours bien spécifié.</p>
<p>Le modèle peut alors être estimé en utilisant par exemple la fonction <code>dynlm::dynlm()</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tvCoef)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dynlm)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">window</span>(manufacturing, <span class="at">start =</span> <span class="dv">1993</span>, <span class="at">end =</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">4</span>))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> data[, <span class="st">"prod_c5"</span>]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>model_c5 <span class="ot">&lt;-</span> <span class="fu">dynlm</span>(</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> prod_c5 <span class="sc">~</span> overhang_ipi1_c5 <span class="sc">+</span> insee_bc_c5_m3 <span class="sc">+</span> insee_oscd_c5_m2</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="fu">diff</span>(insee_tppre_c5_m3, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">diff</span>(bdf_tuc_c5_m2, <span class="dv">1</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>model_c5</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Time series regression with "ts" data:
Start = 1993(2), End = 2019(4)

Call:
dynlm(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + 
    insee_oscd_c5_m2 + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, 
    1), data = data)

Coefficients:
               (Intercept)            overhang_ipi1_c5  
                 -6.383023                    0.102405  
            insee_bc_c5_m3            insee_oscd_c5_m2  
                  0.061437                   -0.005596  
diff(insee_tppre_c5_m3, 1)      diff(bdf_tuc_c5_m2, 1)  
                  0.039043                    0.397070  </code></pre>
</div>
</div>
<p>Les prévisions dans l’échantillon (<em>in sample</em>) peuvent être extraites avec les fonctions <code>fitted()</code> ou <code>predict()</code> et les prévisions en temps-réel (<em>out of sample</em>) avec la fonction <code>tvCoef::oos_prev()</code>.</p>
<p>Pour évaluer la qualité en temps-réel, nous utiliserons les résidus à partir de 2000 :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>prev_oos_lm <span class="ot">&lt;-</span> <span class="fu">oos_prev</span>(model_c5)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>res_lm_is <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model_c5)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>res_lm_oos <span class="ot">&lt;-</span> prev_oos_lm<span class="sc">$</span>residuals</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>rmse_lm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">IS =</span> <span class="fu">rmse</span>(res_lm_is), <span class="at">OOS =</span> <span class="fu">rmse</span>(res_lm_oos))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>rmse_lm</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       IS       OOS 
0.6990756 0.8494077 </code></pre>
</div>
</div>
<p>Pour tracer les prévisions, on peut utiliser la fonction <code>plot()</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">window</span>(y, <span class="at">start =</span> <span class="dv">2000</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(prev_oos_lm<span class="sc">$</span>prevision, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"y"</span>,<span class="st">"Prev. temps réel"</span>),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="TP_files/figure-html/prev-lm-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="régression-par-morceaux" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Régression par morceaux</h1>
<p>Pour utiliser la régression par morceaux, la première étape est d’analyser les potentielles dates de rupture. Pour cela nous utiliserons la fonction <code>tvCoef::piece_reg()</code> (qui s’appuie sur le package <code>strucchange</code>, voir <code>?strucchange::breakpoints()</code> pour plus d’informations).</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercice
</div>
</div>
<div class="callout-body-container callout-body">
<p>Utiliser la fonction <code>tvCoef::piece_reg()</code> sur le modèle précédent et regarder les résultats : y a-t-il des dates de ruptures ? Peuvent-elles être interprétées ?</p>
<p>En utilisant notamment <code>oos_prev()</code>, comparer la qualité prédictive des modèles.</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>reg_morceaux <span class="ot">&lt;-</span> <span class="fu">piece_reg</span>(model_c5)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Ici une date de rupture</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Si pas de rupture détectée, le modèle renvoyé est le modèle initial</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>reg_morceaux </span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$model

Time series regression with "ts" data:
Start = 1993(2), End = 2019(4)

Call:
dynlm::dynlm(formula = as.formula(formula), data = data2)

Coefficients:
               `(Intercept)_2008.75`              overhang_ipi1_c5_2008.75  
                             1.70092                               0.10847  
              insee_bc_c5_m3_2008.75              insee_oscd_c5_m2_2008.75  
                            -0.01335                               0.03653  
`diff(insee_tppre_c5_m3, 1)_2008.75`      `diff(bdf_tuc_c5_m2, 1)_2008.75`  
                             0.04306                               0.48388  
               `(Intercept)_2019.75`              overhang_ipi1_c5_2019.75  
                           -11.60377                               0.47441  
              insee_bc_c5_m3_2019.75              insee_oscd_c5_m2_2019.75  
                             0.10798                              -0.03376  
`diff(insee_tppre_c5_m3, 1)_2019.75`      `diff(bdf_tuc_c5_m2, 1)_2019.75`  
                             0.03414                               0.18874  


$start
[1] 1993    2

$end
[1] 2019    4

$frequency
[1] 4

$breakdates
[1] 2008.75

$tvlm
[1] FALSE

attr(,"class")
[1] "piecereg"</code></pre>
</div>
</div>
<p>L’objet précédent est une liste qui contient différentes informations, notamment :</p>
<ul>
<li><p><code>model</code> : le modèle <code>dynlm</code> estimé ;</p></li>
<li><p><code>breakdates</code> : la date de rupture : 2008T4.</p></li>
</ul>
<p>Analysons maintenant les erreurs de prévision :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>prev_oos_rm <span class="ot">&lt;-</span> <span class="fu">oos_prev</span>(reg_morceaux)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>res_rm_is <span class="ot">&lt;-</span> <span class="fu">residuals</span>(reg_morceaux<span class="sc">$</span>model)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>res_rm_oos <span class="ot">&lt;-</span> prev_oos_rm<span class="sc">$</span>residuals</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">start</span>(res_rm_oos) <span class="co"># Commence en 2000 T2</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2000    2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>rmse_rm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">IS =</span> <span class="fu">rmse</span>(res_rm_is), <span class="at">OOS =</span> <span class="fu">rmse</span>(res_rm_oos))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(rmse_lm, rmse_rm)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               IS       OOS
rmse_lm 0.6990756 0.8494077
rmse_rm 0.5731039 1.3826525</code></pre>
</div>
</div>
<p>Elle sont ici réduites dans l’échantillon mais augmentent en temps réel ! En regardant plus précisément, cela vient d’erreurs élevées autour de la date de rupture car l’estimation n’est pas suffisamment robuste !</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(res_rm_oos, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">main =</span> <span class="st">"Résidus en temps-réel"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(res_lm_oos, <span class="at">col =</span> <span class="st">"black"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"LM"</span>,<span class="st">"Reg. par morceaux"</span>),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="TP_files/figure-html/oos-lm-rm-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>En analysant les prévisions à partir de 2010, les erreurs sont réduites par rapport à précédemment mais restent plus élevées que celles de la régression linéaire :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">window</span>(<span class="fu">ts.union</span>(res_lm_oos, res_rm_oos), <span class="at">start =</span> <span class="dv">2010</span>), <span class="dv">2</span>, rmse)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>res_lm_oos res_rm_oos 
 0.7863127  1.1067406 </code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercice
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le modèle précédent suppose une rupture sur toutes les variables : est-ce réaliste dans ce cas ? Appliquer la fonction <code>tvCoef::hansen.test()</code> sur votre modèle et interpréter les résultats.</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hansen.test</span>(model_c5)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Variable                  L        Stat     Conclusion 
______________________________________________________________ 
(Intercept)                  0.2561   0.47   FALSE   
overhang_ipi1_c5             0.8564   0.47    TRUE   
insee_bc_c5_m3               0.2708   0.47   FALSE   
insee_oscd_c5_m2             0.1508   0.47   FALSE   
diff(insee_tppre_c5_m3, 1)   0.2568   0.47   FALSE   
diff(bdf_tuc_c5_m2, 1)       0.1533   0.47   FALSE   
Variance                     0.4562   0.47   FALSE   
Joint Lc                     1.6516   2.11   FALSE   


Lecture: True means reject H0 at level 5% </code></pre>
</div>
</div>
<p>Le test de Hansen conclut que seul l’acquis d’IPI évolue. Attention à l’interprétation du test sur la constante : si cette variable évolue il est possible que la constante aussi.</p>
<p>On peut également faire des tests de Fisher sur le modèle précédent pour tester si les coefficients sont égaux entre les sous-périodes. Cela peut être fait avec la fonction <code>car::linearHypothesis()</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># on rejette H0 =&gt; non constance des coefficients</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>car<span class="sc">::</span><span class="fu">linearHypothesis</span>(reg_morceaux<span class="sc">$</span>model, <span class="st">"`(Intercept)_2008.75` = `(Intercept)_2019.75`"</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear hypothesis test

Hypothesis:
(Intercept)_2008.75` - Intercept)_2019.75` = 0

Model 1: restricted model
Model 2: y ~ 0 + (`(Intercept)_2008.75` + overhang_ipi1_c5_2008.75 + insee_bc_c5_m3_2008.75 + 
    insee_oscd_c5_m2_2008.75 + `diff(insee_tppre_c5_m3, 1)_2008.75` + 
    `diff(bdf_tuc_c5_m2, 1)_2008.75` + `(Intercept)_2019.75` + 
    overhang_ipi1_c5_2019.75 + insee_bc_c5_m3_2019.75 + insee_oscd_c5_m2_2019.75 + 
    `diff(insee_tppre_c5_m3, 1)_2019.75` + `diff(bdf_tuc_c5_m2, 1)_2019.75`)

  Res.Df    RSS Df Sum of Sq      F  Pr(&gt;F)  
1     96 37.058                              
2     95 35.144  1    1.9145 5.1751 0.02516 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># on rejette H0 =&gt; non constance des coefficients</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>car<span class="sc">::</span><span class="fu">linearHypothesis</span>(reg_morceaux<span class="sc">$</span>model, <span class="st">"overhang_ipi1_c5_2019.75 = overhang_ipi1_c5_2008.75"</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear hypothesis test

Hypothesis:
- overhang_ipi1_c5_2008.75  + overhang_ipi1_c5_2019.75 = 0

Model 1: restricted model
Model 2: y ~ 0 + (`(Intercept)_2008.75` + overhang_ipi1_c5_2008.75 + insee_bc_c5_m3_2008.75 + 
    insee_oscd_c5_m2_2008.75 + `diff(insee_tppre_c5_m3, 1)_2008.75` + 
    `diff(bdf_tuc_c5_m2, 1)_2008.75` + `(Intercept)_2019.75` + 
    overhang_ipi1_c5_2019.75 + insee_bc_c5_m3_2019.75 + insee_oscd_c5_m2_2019.75 + 
    `diff(insee_tppre_c5_m3, 1)_2019.75` + `diff(bdf_tuc_c5_m2, 1)_2019.75`)

  Res.Df    RSS Df Sum of Sq      F    Pr(&gt;F)    
1     96 44.941                                  
2     95 35.144  1    9.7974 26.484 1.429e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># on ne rejette pas H0 =&gt; constance des coefficients</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>car<span class="sc">::</span><span class="fu">linearHypothesis</span>(reg_morceaux<span class="sc">$</span>model, <span class="st">"`diff(insee_tppre_c5_m3, 1)_2019.75` = `diff(insee_tppre_c5_m3, 1)_2008.75`"</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear hypothesis test

Hypothesis:
- diff(insee_tppre_c5_m3,_2008.75`  + diff(insee_tppre_c5_m3,_2019.75` = 0

Model 1: restricted model
Model 2: y ~ 0 + (`(Intercept)_2008.75` + overhang_ipi1_c5_2008.75 + insee_bc_c5_m3_2008.75 + 
    insee_oscd_c5_m2_2008.75 + `diff(insee_tppre_c5_m3, 1)_2008.75` + 
    `diff(bdf_tuc_c5_m2, 1)_2008.75` + `(Intercept)_2019.75` + 
    overhang_ipi1_c5_2019.75 + insee_bc_c5_m3_2019.75 + insee_oscd_c5_m2_2019.75 + 
    `diff(insee_tppre_c5_m3, 1)_2019.75` + `diff(bdf_tuc_c5_m2, 1)_2019.75`)

  Res.Df    RSS Df Sum of Sq      F Pr(&gt;F)
1     96 35.201                           
2     95 35.144  1  0.056906 0.1538 0.6958</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercice
</div>
</div>
<div class="callout-body-container callout-body">
<p>En exploitant les résultats de l’exercice précédent, simplifier le modèle de régression par morceaux.</p>
<p>On pourra pour cela utiliser le paramètre <code>fixed_var</code> de <code>piece_reg()</code> pour fixer certaines variables (i.e.&nbsp;: ne pas découper les régresseurs).</p>
<p>Comparer les prévisions avec les modèles précédents.</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Ici nous allons fixer toutes les variables sauf les deux premières (constante + acquis d’IPI – <em>overhang</em>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>reg_morceaux2 <span class="ot">&lt;-</span> <span class="fu">piece_reg</span>(model_c5, <span class="at">fixed_var =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Rmq : la date de rupture est détectée sur le modèle complet et non</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  sur le sous-modèle avec des variables fixes</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>reg_morceaux2 </span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$model

Time series regression with "ts" data:
Start = 1993(2), End = 2019(4)

Call:
dynlm::dynlm(formula = as.formula(formula), data = data2)

Coefficients:
              insee_bc_c5_m3              insee_oscd_c5_m2  
                    0.042179                      0.005864  
`diff(insee_tppre_c5_m3, 1)`      `diff(bdf_tuc_c5_m2, 1)`  
                    0.042554                      0.331692  
       `(Intercept)_2008.75`      overhang_ipi1_c5_2008.75  
                   -4.386765                      0.106947  
       `(Intercept)_2019.75`      overhang_ipi1_c5_2019.75  
                   -4.152134                      0.443726  


$start
[1] 1993    2

$end
[1] 2019    4

$frequency
[1] 4

$breakdates
[1] 2008.75

$tvlm
[1] FALSE

attr(,"class")
[1] "piecereg"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>prev_oos_rm2 <span class="ot">&lt;-</span> <span class="fu">oos_prev</span>(reg_morceaux2)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>res_rm2_is <span class="ot">&lt;-</span> <span class="fu">residuals</span>(reg_morceaux2<span class="sc">$</span>model)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>res_rm2_oos <span class="ot">&lt;-</span> prev_oos_rm2<span class="sc">$</span>residuals</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>rmse_rm2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">IS =</span> <span class="fu">rmse</span>(res_rm2_is), <span class="at">OOS =</span> <span class="fu">rmse</span>(res_rm2_oos))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(rmse_lm, rmse_rm, rmse_rm2)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                IS       OOS
rmse_lm  0.6990756 0.8494077
rmse_rm  0.5731039 1.3826525
rmse_rm2 0.6003532 0.8747103</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Après 2010</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">window</span>(<span class="fu">ts.union</span>(res_lm_oos, res_rm_oos, res_rm2_oos), <span class="at">start =</span> <span class="dv">2010</span>), <span class="dv">2</span>, rmse)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> res_lm_oos  res_rm_oos res_rm2_oos 
  0.7863127   1.1067406   0.7050171 </code></pre>
</div>
</div>
<p>Cela permet d’améliorer la qualité de la prévision en temps-réel mais pas celle dans l’échantillon.</p>
</div>
</div>
</div>
</section>
<section id="régression-locale" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Régression locale</h1>
<p>Pour rappel, la régression locale revient, pour chaque date <span class="math inline">\(t\)</span> à estimer <span class="math inline">\(\beta_t\)</span></p>
<p><span class="math display">\[
\DeclareMathOperator{\argmin}{argmin}
\hat \beta = \underset{\theta_0}{\argmin}\sum_{j=1}^T\left(y_{j}-x_j\theta_0\right)^2K_b\left(\frac{j-t}{T}\right)
\]</span></p>
<p>Dans le package ici utilisé (<code>tvReg</code>), le noyau utilisé par défaut est le noyau tricube :</p>
<p><span class="math display">\[
K(x)=\frac{35}{32}\left(
  1-
  \left\lvert
  x
  \right\lvert^2
\right)^3 \mathbb 1_{|x| \leq 1}
\text{ et }
K_b(x)=\frac 1 b K(x/b)
\]</span></p>
<p>Pour estimer le modèle, nous utilisons la fonction <code>tvReg::tvLM</code> dont le premier paramètre est une formule. Mais contrairement à <code>dynlm</code>, <code>tvLM</code> ne gère pas directement les variables en différence :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tvReg)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>tvReg<span class="sc">::</span><span class="fu">tvLM</span>(<span class="at">formula =</span> prod_c5 <span class="sc">~</span> overhang_ipi1_c5 <span class="sc">+</span> insee_bc_c5_m3 <span class="sc">+</span> insee_oscd_c5_m2</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="fu">diff</span>(insee_tppre_c5_m3, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">diff</span>(bdf_tuc_c5_m2, <span class="dv">1</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in model.frame.default(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + : les longueurs des variables diffèrent (trouvé pour 'diff(insee_tppre_c5_m3, 1)')</code></pre>
</div>
</div>
<p>Pour éviter les problèmes liées au variables en différence, nous récupérons les données transformées de <code>dynlm</code> en utilisant la fonction <code>tvCoef::get_data(model_c5)</code>, ce qui permet également de simplifier la formule en <code>prod_c5 ~ .</code>(puisque la base de données alors utilisée ne contient que les exogènes utiles).</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercice
</div>
</div>
<div class="callout-body-container callout-body">
<p>Estimer le modèle en utilisant les indications précédentes.</p>
<p>Quelle fenêtre est utilisée (paramètre <span class="math inline">\(b\)</span>) ? Est-ce que les résultats sont différents de ceux de la régression linéaire ? Tracer les coefficients obtenus à chaque date (fonction <code>coef()</code> pour les extraire, il faudrait reconvertir le résultat en objet <code>ts()</code>)</p>
<p>Comparer les erreurs de prévision dans l’échantillon avec ceux des modèles précédents.</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>La fenêtre retenue est de 0,31 : les résultats seront donc différents de ceux de la régression linéaire.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>tvlm <span class="ot">&lt;-</span> tvReg<span class="sc">::</span><span class="fu">tvLM</span>(<span class="at">formula =</span> prod_c5 <span class="sc">~</span> .,</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> <span class="fu">get_data</span>(model_c5))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating regression bandwidth... bw =  0.4698719 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>coefs_tvlm <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">coef</span>(tvlm), <span class="at">end =</span> <span class="fu">end</span>(data), <span class="at">frequency =</span> <span class="fu">frequency</span>(data))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(coefs_tvlm)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="TP_files/figure-html/coef-tvlm-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Ici toutes les coefficients sont variables alors que certains pourraient être fixes comme vu dans la partie précédente. Pour fixer certaines variables, on pourrait faire une régression en deux étapes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>res_tvlm_is <span class="ot">&lt;-</span> <span class="fu">residuals</span>(tvlm)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>rmse_tvlm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">IS =</span> <span class="fu">rmse</span>(res_tvlm_is), <span class="at">OOS =</span> <span class="cn">NA</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(rmse_lm, rmse_rm, rmse_rm2, rmse_tvlm)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 IS       OOS
rmse_lm   0.6990756 0.8494077
rmse_rm   0.5731039 1.3826525
rmse_rm2  0.6003532 0.8747103
rmse_tvlm 0.5971192        NA</code></pre>
</div>
</div>
<p>Le RMSE dans l’échantillon est réduit.</p>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercice
</div>
</div>
<div class="callout-body-container callout-body">
<p>L’objectif de cet exercice est de calculer les prévisions hors échantillon.</p>
<p>Appliquer la fonction <code>tvCoef::oos_prev()</code> au modèle précédent avec les paramètres <code>end = end(data), frequency = frequency(data)</code> (utiles pour garder la structure temporelle des données) : quels sont les paramètres réestimés ?</p>
<p>Appliquer maintenant la même fonction avec le paramètre <code>fixed_bw = TRUE</code>. À quoi cela correspond ? Comparer les erreurs de prévisions obtenus.</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Dans les modèles de régression locales, il y a deux sources de révisions en temps-réel :</p>
<ol type="1">
<li><p>Actualisation des coefficients du fait de l’ajout de nouveaux points (noyau asymétrique utilisé pour les premières estimations)</p></li>
<li><p>Actualisation de la fenêtre.</p></li>
</ol>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Actualisation de la fenêtre et des coefficients
</div>
</div>
<div class="callout-body-container callout-body">
<p>Par défaut, avec <code>oos_prev()</code> tous les paramètres sont réestimés. C’est en particulier le cas de la fenêtre qui est réestimée à chaque date, à chaque observation :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>prev_oos_tvlm_all <span class="ot">&lt;-</span> <span class="fu">oos_prev</span>(tvlm, <span class="at">end =</span> <span class="fu">end</span>(data), <span class="at">frequency =</span> <span class="fu">frequency</span>(data))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  20 
Calculating regression bandwidth... bw =  1.419831 
Calculating regression bandwidth... bw =  2.82952 
Calculating regression bandwidth... bw =  1.223547 
Calculating regression bandwidth... bw =  1.170575 
Calculating regression bandwidth... bw =  1.15924 
Calculating regression bandwidth... bw =  1.149263 
Calculating regression bandwidth... bw =  1.042411 
Calculating regression bandwidth... bw =  0.9797272 
Calculating regression bandwidth... bw =  0.4014617 
Calculating regression bandwidth... bw =  0.8781985 
Calculating regression bandwidth... bw =  0.4896312 
Calculating regression bandwidth... bw =  0.491814 
Calculating regression bandwidth... bw =  0.504626 
Calculating regression bandwidth... bw =  0.4866928 
Calculating regression bandwidth... bw =  0.3382399 
Calculating regression bandwidth... bw =  0.4753745 
Calculating regression bandwidth... bw =  0.4747202 
Calculating regression bandwidth... bw =  0.478007 
Calculating regression bandwidth... bw =  0.4662297 
Calculating regression bandwidth... bw =  0.4636153 
Calculating regression bandwidth... bw =  0.7847365 
Calculating regression bandwidth... bw =  0.7712849 
Calculating regression bandwidth... bw =  0.4601159 
Calculating regression bandwidth... bw =  0.4618806 
Calculating regression bandwidth... bw =  0.4630616 
Calculating regression bandwidth... bw =  0.4480051 
Calculating regression bandwidth... bw =  0.4333001 
Calculating regression bandwidth... bw =  0.4067395 
Calculating regression bandwidth... bw =  0.7120287 
Calculating regression bandwidth... bw =  0.7082321 
Calculating regression bandwidth... bw =  0.3906645 
Calculating regression bandwidth... bw =  0.3970553 
Calculating regression bandwidth... bw =  0.3421958 
Calculating regression bandwidth... bw =  0.3365896 
Calculating regression bandwidth... bw =  0.329112 
Calculating regression bandwidth... bw =  0.3323843 
Calculating regression bandwidth... bw =  0.649492 
Calculating regression bandwidth... bw =  0.4963082 
Calculating regression bandwidth... bw =  0.552225 
Calculating regression bandwidth... bw =  0.6002736 
Calculating regression bandwidth... bw =  0.5783915 
Calculating regression bandwidth... bw =  0.4433933 
Calculating regression bandwidth... bw =  0.4365778 
Calculating regression bandwidth... bw =  0.4698719 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>all_bw <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">sapply</span>(prev_oos_tvlm_all<span class="sc">$</span>model, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="st">"bw"</span>),</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">end =</span> <span class="fu">end</span>(prev_oos_tvlm_all<span class="sc">$</span>prevision),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">frequency =</span> <span class="fu">frequency</span>(data))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(all_bw)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="TP_files/figure-html/bw-tvlm-soos-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>res_tvlm_all_oos <span class="ot">&lt;-</span> prev_oos_tvlm_all<span class="sc">$</span>residuals</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>rmse_tvlm[<span class="st">"OOS"</span>] <span class="ot">&lt;-</span> <span class="fu">rmse</span>(res_tvlm_all_oos)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(rmse_lm, rmse_rm, rmse_rm2, rmse_tvlm)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 IS       OOS
rmse_lm   0.6990756 0.8494077
rmse_rm   0.5731039 1.3826525
rmse_rm2  0.6003532 0.8747103
rmse_tvlm 0.5971192 0.8595945</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Après 2010</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">window</span>(<span class="fu">ts.union</span>(res_lm_oos, res_rm_oos, res_rm2_oos, res_tvlm_all_oos), <span class="at">start =</span> <span class="dv">2010</span>), <span class="dv">2</span>, rmse)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      res_lm_oos       res_rm_oos      res_rm2_oos res_tvlm_all_oos 
       0.7863127        1.1067406        0.7050171        0.8075138 </code></pre>
</div>
</div>
</div>
</div>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Actualisation des coefficients uniquement
</div>
</div>
<div class="callout-body-container callout-body">
<p>Fixons maintenant la fenêtre à la dernière valeur estimée :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>prev_oos_tvlm_lastbw <span class="ot">&lt;-</span> <span class="fu">oos_prev</span>(tvlm, <span class="at">end =</span> <span class="fu">end</span>(data), <span class="at">frequency =</span> <span class="fu">frequency</span>(data),<span class="at">fixed_bw =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>res_tvlm_lastbw_oos <span class="ot">&lt;-</span> prev_oos_tvlm_lastbw<span class="sc">$</span>residuals</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>rmse_tvlm[<span class="st">"OOS"</span>] <span class="ot">&lt;-</span> <span class="fu">rmse</span>(res_tvlm_lastbw_oos)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(rmse_lm, rmse_rm, rmse_rm2, rmse_tvlm)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 IS       OOS
rmse_lm   0.6990756 0.8494077
rmse_rm   0.5731039 1.3826525
rmse_rm2  0.6003532 0.8747103
rmse_tvlm 0.5971192 0.9799976</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Après 2010</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">window</span>(<span class="fu">ts.union</span>(res_lm_oos, res_rm_oos, res_rm2_oos, res_tvlm_all_oos, res_tvlm_lastbw_oos), <span class="at">start =</span> <span class="dv">2010</span>), <span class="dv">2</span>, rmse)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         res_lm_oos          res_rm_oos         res_rm2_oos    res_tvlm_all_oos 
          0.7863127           1.1067406           0.7050171           0.8075138 
res_tvlm_lastbw_oos 
          0.7231632 </code></pre>
</div>
</div>
<p>Le RMSE en temps-réel est réduit par rapport à précédemment mais il reste plus élevé qu’avec la régression linéaire.</p>
</div>
</div>
</div>
</div>
</div>
<div class="callout-remarque callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Remarque
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour fixer certaines variables, on pourrait faire une régression en deux étapes. La fonction <code>rmse_prev()</code> permet de calculer les prévisions dans l’échantillon et hors échantillon sur le modèle de régression linéaire, la régression par morceaux, la régression locale en fixant ou non certains coefficients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>comp_prev <span class="ot">&lt;-</span> <span class="fu">rmse_prev</span>(model_c5, <span class="at">fixed_var =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>), <span class="at">fixed_bw =</span> <span class="cn">TRUE</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating regression bandwidth... bw =  0.4698719 
Calculating regression bandwidth... bw =  0.3501963 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>comp_prev</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       RMSE_in_sample RMSE_out_of_sample
lm                          0.6990756          0.8494077
piece_lm                    0.5731039          1.3826525
piece_lm fixed coeff        0.6003532          0.8747103
TvLM                        0.5971192          0.9799976
piece_tvlm                  0.5354897          1.4605933
piece_tvlm fixed coeff      0.5470547          1.0154322
TvLM fixed coeff            0.6254196          0.8574867</code></pre>
</div>
</div>
<p>Sept modèles différents sont estimés, dans l’ordre :</p>
<ol type="1">
<li><p>Modèle de régression linéaire.</p></li>
<li><p>Régression linéaire par morceaux où toutes les variables divisées en fonction de la date de rupture.</p></li>
<li><p>Régression linéaire par morceaux où toutes les variables, sauf celles spécifiées par <code>fixed_var</code>, sont divisées en fonction de la date de rupture.</p></li>
<li><p>Régression locale.</p></li>
<li><p>Régression locale avec toutes les variables divisées en fonction de la date de rupture.</p></li>
<li><p>Régression locale où toutes les variables, sauf celles spécifiées par <code>fixed_var</code>, sont divisées en fonction de la date de rupture.</p></li>
<li><p>Régression locale où les variables celles spécifiées par <code>fixed_var</code> sont estimées par une régression linéaire (coefficients fixes sur l’ensemble de la période).</p></li>
</ol>
<p>On peut ensuite récupérer tous les résidus en temps réel :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>comp_prev_tr <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(comp_prev<span class="sc">$</span>prevision, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="st">"residuals"</span>))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">window</span>(comp_prev_tr, <span class="at">start =</span> <span class="dv">2010</span>), <span class="dv">2</span>, rmse)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             prev_lm        prev_piece_lm   prev_piece_lm_fixe 
           0.7863127            1.1067406            0.7050171 
           prev_tvlm      prev_piece_tvlm prev_piece_tvlm_fixe 
           0.7231632            1.0894378            0.7072981 
      prev_tvlm_fixe 
           0.7246941 </code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="modèles-espace-état" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Modèles espace-état</h1>
<p>Dans cette dernière partie nous estimons un modèle espace-état avec coefficients qui varient dans le temps.</p>
<p>Pour rappel, puisque nous avons 6 variables exogènes, le modèle s’écrit :</p>
<p><span class="math display">\[
\begin{cases}
y_t=X_t\alpha_t+\varepsilon_t,\quad&amp;\varepsilon_t\sim\mathcal N(0,\sigma^2)\\
\alpha_{t+1}=\alpha_t+\eta_t,\quad&amp;\eta_t\sim\mathcal N(0,\sigma^2 Q)
\end{cases},\text{ avec }\eta_t\text{ et }\varepsilon_t\text{ indépendants et }
Q = \begin{pmatrix}q_1 &amp;  &amp;0 \\ &amp; \ddots \\ 0 &amp; &amp; q_6 \end{pmatrix}
\]</span></p>
<p>La matrice <span class="math inline">\(Q\)</span> peut-être imposée par l’utilisateur (par exemple variance nulle si l’on veut fixer tous les coefficients) ou estimée.</p>
<p>Il y a également deux opérations classiques :</p>
<ul>
<li><p><em>smoothing</em> : estimation de <span class="math inline">\(\hat\alpha_t=E[\alpha_t|y]\)</span> et <span class="math inline">\(V_t=V[\alpha_t-\hat\alpha_t]=V[\alpha_t|y]\)</span> : coefficients et variances estimés en utilisant l’ensemble des données disponibles ;</p></li>
<li><p><em>filtering</em> : estimation de <span class="math inline">\(a_{t+1}=E[\alpha_{t+1}|Y_t]\)</span> et <span class="math inline">\(P_{t+1}=V[\alpha_{t+1}|Y_t]\)</span> : coefficients et variances estimés de manière dynamique en utilisant l’information disponible jusqu’à la date précédente (estimation en temps-réel).</p></li>
</ul>
<p>Pour estimer ces modèles nous utiliserons la fonction <code>tvCoef::ssm_lm()</code> dont le premier paramètre est un modèle de régression linéaire (le modèle <code>model_c5</code>).</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercice
</div>
</div>
<div class="callout-body-container callout-body">
<p>Par défaut, <code>tvCoef::ssm_lm()</code> estime le modèle en forçant <span class="math inline">\(q_1=q_2=\dots=q_6=0\)</span>. Quel modèle retrouve-t-on ? Regarder les résultats de cette fonction et interpréter les quantités de <code>"smoothed_states"</code>, <code>"filtering_states"</code>,<code>"smoothed_stdev"</code> (sauf dernière colonne).</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Le modèle estimé est le modèle de régression linéaire !</p>
<p>La composante <code>smoothed_states</code> contient les coefficients du modèle de régression linéaire estimé en utilisant toutes les données. La dernière colonne (<code>"noise"</code>) contient les résidus. La composante <code>smoothed_stdev</code> contient les écart-types associés aux différents coefficients, la dernière colonne s’interprète de manière plus complexe et ne sera pas détaillée ici.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>mod_ssm <span class="ot">&lt;-</span> <span class="fu">ssm_lm</span>(model_c5)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_c5)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Time series regression with "ts" data:
Start = 1993(2), End = 2019(4)

Call:
dynlm(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + 
    insee_oscd_c5_m2 + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, 
    1), data = data)

Residuals:
    Min      1Q  Median      3Q     Max 
-2.3241 -0.4566  0.0140  0.4495  1.6115 

Coefficients:
                            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                -6.383023   3.213333  -1.986  0.04970 *  
overhang_ipi1_c5            0.102405   0.022681   4.515 1.72e-05 ***
insee_bc_c5_m3              0.061437   0.029218   2.103  0.03797 *  
insee_oscd_c5_m2           -0.005596   0.015019  -0.373  0.71021    
diff(insee_tppre_c5_m3, 1)  0.039043   0.012029   3.246  0.00159 ** 
diff(bdf_tuc_c5_m2, 1)      0.397070   0.077580   5.118 1.48e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.7195 on 101 degrees of freedom
Multiple R-squared:  0.7155,    Adjusted R-squared:  0.7014 
F-statistic: 50.79 on 5 and 101 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(mod_ssm<span class="sc">$</span>smoothed_states, <span class="dv">3</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       (Intercept) overhang_ipi1_c5 insee_bc_c5_m3 insee_oscd_c5_m2
[105,]   -6.383023        0.1024052     0.06143715     -0.005596399
[106,]   -6.383023        0.1024052     0.06143715     -0.005596399
[107,]   -6.383023        0.1024052     0.06143715     -0.005596399
       diff(insee_tppre_c5_m3, 1) diff(bdf_tuc_c5_m2, 1)      noise
[105,]                 0.03904254              0.3970705  0.5785851
[106,]                 0.03904254              0.3970705  0.1141372
[107,]                 0.03904254              0.3970705 -0.6226152</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(mod_ssm<span class="sc">$</span>smoothed_stdev, <span class="dv">3</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       (Intercept) overhang_ipi1_c5 insee_bc_c5_m3 insee_oscd_c5_m2
[105,]    3.213333       0.02268142     0.02921753       0.01501868
[106,]    3.213333       0.02268142     0.02921753       0.01501868
[107,]    3.213333       0.02268142     0.02921753       0.01501868
       diff(insee_tppre_c5_m3, 1) diff(bdf_tuc_c5_m2, 1)     noise
[105,]                 0.01202881             0.07757954 0.1554965
[106,]                 0.01202881             0.07757954 0.1367629
[107,]                 0.01202881             0.07757954 0.1460395</code></pre>
</div>
</div>
<p>La composante <code>filtering_states</code> donne les estimations des coefficients en temps réel : la valeur à la date <span class="math inline">\(t\)</span> correspond aux estimations des coefficients en utilisant les données jusqu’en <span class="math inline">\(t-1\)</span>. Ainsi, en estimant le modèle jusqu’en 2010T1, les coefficients obtenus sont ceux de la composante <code>filtering_states</code> de 2010T2&nbsp;:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">dynlm</span>(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> prod_c5 <span class="sc">~</span> overhang_ipi1_c5 <span class="sc">+</span> insee_bc_c5_m3 <span class="sc">+</span> insee_oscd_c5_m2</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="fu">diff</span>(insee_tppre_c5_m3, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">diff</span>(bdf_tuc_c5_m2, <span class="dv">1</span>),</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">window</span>(data, <span class="at">end =</span> <span class="dv">2010</span>)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Time series regression with "ts" data:
Start = 1993(2), End = 2010(1)

Call:
dynlm(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + 
    insee_oscd_c5_m2 + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, 
    1), data = window(data, end = 2010))

Residuals:
     Min       1Q   Median       3Q      Max 
-1.93741 -0.36837 -0.02174  0.41270  1.50865 

Coefficients:
                            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                 0.687568   4.010977   0.171 0.864451    
overhang_ipi1_c5            0.096558   0.029839   3.236 0.001947 ** 
insee_bc_c5_m3             -0.003804   0.036838  -0.103 0.918081    
insee_oscd_c5_m2            0.027262   0.018837   1.447 0.152869    
diff(insee_tppre_c5_m3, 1)  0.047953   0.013331   3.597 0.000639 ***
diff(bdf_tuc_c5_m2, 1)      0.595962   0.104419   5.707 3.46e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.6887 on 62 degrees of freedom
Multiple R-squared:  0.8058,    Adjusted R-squared:  0.7902 
F-statistic: 51.46 on 5 and 62 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">window</span>(mod_ssm<span class="sc">$</span>filtering_states, <span class="at">start =</span> <span class="dv">2010</span>, <span class="at">end =</span> <span class="fu">c</span>(<span class="dv">2010</span>,<span class="dv">2</span>))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        (Intercept) overhang_ipi1_c5 insee_bc_c5_m3 insee_oscd_c5_m2
2010 Q1   0.4262027       0.09515354   -0.001352874       0.02587391
2010 Q2   0.6875678       0.09655775   -0.003804293       0.02726163
        diff(insee_tppre_c5_m3, 1) diff(bdf_tuc_c5_m2, 1) noise
2010 Q1                 0.04759521              0.5960833     0
2010 Q2                 0.04795263              0.5959618     0</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercice
</div>
</div>
<div class="callout-body-container callout-body">
<p>Estimer maintenant le modèle en utilisant les paramètres suivants :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>model_ssm <span class="ot">&lt;-</span> <span class="fu">ssm_lm</span>(model_c5,</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">var_intercept =</span> <span class="fl">0.01</span>, <span class="at">fixed_var_intercept =</span> <span class="cn">FALSE</span>,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">var_variables =</span> <span class="fl">0.01</span>, <span class="at">fixed_var_variables =</span> <span class="cn">FALSE</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Les paramètres <code>fixed_var_intercept = FALSE</code> et <code>fixed_var_variables = FALSE</code> permettent d’indiquer que les variances <span class="math inline">\(q_1,\dots, q_6\)</span> seront estimées. Les paramètres <code>var_intercept</code> et <code>var_variables</code> n’auront généralement aucun impact sur les résultats (puisque dans notre cas les variances sont estimées), ils interviennent toutefois dans le processus algorithmique : les modifier permet dans certains cas d’éviter des erreurs d’optimisation.</p>
<p>Regarder les coefficients <code>model_ssm$smoothed_states</code> : quelles sont les variables qui varient dans le temps ? À partir de <code>model_ssm$fitted</code>, comparer la qualité prédictive de ce modèle avec les précédents.</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Les variables fixes sont la constante et les carnets de commandes globaux :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_ssm<span class="sc">$</span>smoothed_states[,<span class="sc">-</span><span class="fu">ncol</span>(model_ssm<span class="sc">$</span>smoothed_states)])</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="TP_files/figure-html/coef-ssm-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>On peut également vérifier en regardant les variances <span class="math inline">\(\sigma^2q_i\)</span> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>model_ssm<span class="sc">$</span>parameters<span class="sc">$</span>parameters <span class="sc">*</span> model_ssm<span class="sc">$</span>parameters<span class="sc">$</span>scaling</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               (Intercept).var           overhang_ipi1_c5.var 
                  1.870276e-03                   3.863439e-04 
            insee_bc_c5_m3.var           insee_oscd_c5_m2.var 
                  0.000000e+00                   1.097830e-06 
diff(insee_tppre_c5_m3, 1).var     diff(bdf_tuc_c5_m2, 1).var 
                  0.000000e+00                   3.462322e-03 
                     noise.var 
                  3.548244e-01 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>res_ssm_is <span class="ot">&lt;-</span> y <span class="sc">-</span> model_ssm<span class="sc">$</span>fitted[,<span class="st">"smoothed"</span>]</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>res_ssm_oos <span class="ot">&lt;-</span> y <span class="sc">-</span> model_ssm<span class="sc">$</span>fitted[,<span class="st">"filtering"</span>]</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>rmse_ssm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">IS =</span> <span class="fu">rmse</span>(res_ssm_is), <span class="at">OOS =</span> <span class="fu">rmse</span>(res_ssm_oos))</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(rmse_lm, rmse_rm, rmse_rm2, rmse_tvlm, rmse_ssm)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 IS       OOS
rmse_lm   0.6990756 0.8494077
rmse_rm   0.5731039 1.3826525
rmse_rm2  0.6003532 0.8747103
rmse_tvlm 0.5971192 0.9799976
rmse_ssm  0.5422771 0.7441522</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Après 2010</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">window</span>(<span class="fu">ts.union</span>(res_lm_oos, res_rm_oos, res_rm2_oos, res_tvlm_lastbw_oos, res_ssm_oos), <span class="at">start =</span> <span class="dv">2010</span>), <span class="dv">2</span>, rmse)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         res_lm_oos          res_rm_oos         res_rm2_oos res_tvlm_lastbw_oos 
          0.7863127           1.1067406           0.7050171           0.7231632 
        res_ssm_oos 
          0.6863295 </code></pre>
</div>
</div>
<p>En réalité, la composante <em>filtering</em> ne correspond pas exactement à de l’estimation en temps-réel car certains paramètres ne sont pas estimés de manière dynamique. Pour avoir une vraie estimation en temps-réel, il faudrait réestimer le modèle à chaque date : on peut pour cela utiliser la fonction <code>ssm_lm_oos()</code>. Pour que cette fonction marche, il faut parfois jouer sur les paramètres <code>var_intercept</code> et <code>var_variables</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>model_ssm_oos <span class="ot">&lt;-</span> <span class="fu">ssm_lm_oos</span>(model_c5,</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">var_intercept =</span> <span class="fl">0.001</span>, <span class="at">fixed_var_intercept =</span> <span class="cn">FALSE</span>,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">var_variables =</span> <span class="fl">0.001</span>, <span class="at">fixed_var_variables =</span> <span class="cn">FALSE</span>)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>res_ssm_oos <span class="ot">&lt;-</span> y <span class="sc">-</span> model_ssm_oos<span class="sc">$</span>prevision</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>rmse_ssm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">IS =</span> <span class="fu">rmse</span>(res_ssm_is), <span class="at">OOS =</span> <span class="fu">rmse</span>(res_ssm_oos))</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(rmse_lm, rmse_rm, rmse_rm2, rmse_tvlm, rmse_ssm)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 IS       OOS
rmse_lm   0.6990756 0.8494077
rmse_rm   0.5731039 1.3826525
rmse_rm2  0.6003532 0.8747103
rmse_tvlm 0.5971192 0.9799976
rmse_ssm  0.5422771 0.7337112</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">window</span>(<span class="fu">ts.union</span>(res_lm_oos, res_rm_oos, res_rm2_oos, res_tvlm_lastbw_oos, res_ssm_oos), <span class="at">start =</span> <span class="dv">2010</span>), <span class="dv">2</span>, rmse)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         res_lm_oos          res_rm_oos         res_rm2_oos res_tvlm_lastbw_oos 
          0.7863127           1.1067406           0.7050171           0.7231632 
        res_ssm_oos 
          0.6571734 </code></pre>
</div>
</div>
<p>On peut enfin faire un graphique avec toutes les prévisions, en utilisant par exemple le package <code>dygraphs</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dygraphs)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>prevs <span class="ot">&lt;-</span> <span class="fu">ts.intersect</span>(y, y <span class="sc">-</span> res_lm_oos, y <span class="sc">-</span> res_rm2_oos, y <span class="sc">-</span> res_tvlm_lastbw_oos, y <span class="sc">-</span> res_ssm_oos)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(prevs) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"lm"</span>, <span class="st">"Reg par morceaux"</span>, <span class="st">"Reg locale"</span>, <span class="st">"SSM"</span>)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dygraph</span>(prevs) <span class="sc">%&gt;%</span> </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dyRangeSelector</span>(<span class="at">dateWindow =</span> <span class="fu">c</span>(<span class="st">"2010-01-01"</span>, <span class="st">"2019-12-01"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dyOptions</span>(<span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"green"</span>, <span class="st">"blue"</span>, <span class="st">"purple"</span>))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="dygraphs html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-928b8b3e3de800b364ce" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-928b8b3e3de800b364ce">{"x":{"attrs":{"labels":["quarter","y","lm","Reg par morceaux","Reg locale","SSM"],"legend":"auto","retainDateWindow":false,"axes":{"x":{"pixelsPerLabel":60,"drawAxis":true},"y":{"drawAxis":true}},"showRangeSelector":true,"dateWindow":["2010-01-01T00:00:00.000Z","2019-12-01T00:00:00.000Z"],"rangeSelectorHeight":40,"rangeSelectorPlotFillColor":" #A7B1C4","rangeSelectorPlotStrokeColor":"#808FAB","interactionModel":"Dygraph.Interaction.defaultModel","stackedGraph":false,"fillGraph":false,"fillAlpha":0.15,"stepPlot":false,"drawPoints":false,"pointSize":1,"drawGapEdgePoints":false,"connectSeparatedPoints":false,"strokeWidth":1,"strokeBorderColor":"white","colors":["black","red","green","blue","purple"],"colorValue":0.5,"colorSaturation":1,"includeZero":false,"drawAxesAtZero":false,"logscale":false,"axisTickSize":3,"axisLineColor":"black","axisLineWidth":0.3,"axisLabelColor":"black","axisLabelFontSize":14,"axisLabelWidth":60,"drawGrid":true,"gridLineWidth":0.3,"rightGap":5,"digitsAfterDecimal":2,"labelsKMB":false,"labelsKMG2":false,"labelsUTC":false,"maxNumberWidth":6,"animatedZooms":false,"mobileDisableYTouch":true,"disableZoom":false},"scale":"quarterly","annotations":[],"shadings":[],"events":[],"format":"date","data":[["2000-04-01T00:00:00.000Z","2000-07-01T00:00:00.000Z","2000-10-01T00:00:00.000Z","2001-01-01T00:00:00.000Z","2001-04-01T00:00:00.000Z","2001-07-01T00:00:00.000Z","2001-10-01T00:00:00.000Z","2002-01-01T00:00:00.000Z","2002-04-01T00:00:00.000Z","2002-07-01T00:00:00.000Z","2002-10-01T00:00:00.000Z","2003-01-01T00:00:00.000Z","2003-04-01T00:00:00.000Z","2003-07-01T00:00:00.000Z","2003-10-01T00:00:00.000Z","2004-01-01T00:00:00.000Z","2004-04-01T00:00:00.000Z","2004-07-01T00:00:00.000Z","2004-10-01T00:00:00.000Z","2005-01-01T00:00:00.000Z","2005-04-01T00:00:00.000Z","2005-07-01T00:00:00.000Z","2005-10-01T00:00:00.000Z","2006-01-01T00:00:00.000Z","2006-04-01T00:00:00.000Z","2006-07-01T00:00:00.000Z","2006-10-01T00:00:00.000Z","2007-01-01T00:00:00.000Z","2007-04-01T00:00:00.000Z","2007-07-01T00:00:00.000Z","2007-10-01T00:00:00.000Z","2008-01-01T00:00:00.000Z","2008-04-01T00:00:00.000Z","2008-07-01T00:00:00.000Z","2008-10-01T00:00:00.000Z","2009-01-01T00:00:00.000Z","2009-04-01T00:00:00.000Z","2009-07-01T00:00:00.000Z","2009-10-01T00:00:00.000Z","2010-01-01T00:00:00.000Z","2010-04-01T00:00:00.000Z","2010-07-01T00:00:00.000Z","2010-10-01T00:00:00.000Z","2011-01-01T00:00:00.000Z","2011-04-01T00:00:00.000Z","2011-07-01T00:00:00.000Z","2011-10-01T00:00:00.000Z","2012-01-01T00:00:00.000Z","2012-04-01T00:00:00.000Z","2012-07-01T00:00:00.000Z","2012-10-01T00:00:00.000Z","2013-01-01T00:00:00.000Z","2013-04-01T00:00:00.000Z","2013-07-01T00:00:00.000Z","2013-10-01T00:00:00.000Z","2014-01-01T00:00:00.000Z","2014-04-01T00:00:00.000Z","2014-07-01T00:00:00.000Z","2014-10-01T00:00:00.000Z","2015-01-01T00:00:00.000Z","2015-04-01T00:00:00.000Z","2015-07-01T00:00:00.000Z","2015-10-01T00:00:00.000Z","2016-01-01T00:00:00.000Z","2016-04-01T00:00:00.000Z","2016-07-01T00:00:00.000Z","2016-10-01T00:00:00.000Z","2017-01-01T00:00:00.000Z","2017-04-01T00:00:00.000Z","2017-07-01T00:00:00.000Z","2017-10-01T00:00:00.000Z","2018-01-01T00:00:00.000Z","2018-04-01T00:00:00.000Z","2018-07-01T00:00:00.000Z","2018-10-01T00:00:00.000Z","2019-01-01T00:00:00.000Z","2019-04-01T00:00:00.000Z","2019-07-01T00:00:00.000Z","2019-10-01T00:00:00.000Z"],[1.41586211509732,0.774997801424671,1.58934473618186,0.155696338451627,-0.592870544090052,0.226483466706928,-2.11982955279129,0.963039511004604,-0.102354145342887,-0.235437739797695,-0.872956909361067,-0.301998258550185,-1.04692941241501,0.384323188988689,0.0957129501847565,1.14523338299717,-0.213261806349485,-0.565139797739445,0.270327162340323,0.480636428926573,-0.30899494171982,0.956330866212962,0.882809256386174,0.233933329001235,1.80334954078876,-0.00742949935788051,1.26204729758417,0.271485623840428,0.560317792180642,0.515613954842187,-0.216150250279235,0.916223583429199,-2.14857189807635,-1.05589084229861,-5.8173949018235,-6.42225601171369,-0.176931502232702,1.78330278769172,0.964283598886451,-0.167783266259136,1.69005476811697,0.509685174055763,1.02110044270685,2.64191319590681,-0.567791159314213,-0.544266244339853,-0.818624262677459,-0.835556962597805,-1.0865971153298,0.591340833640719,-2.15206554747035,-0.0667548924309314,0.474627915152936,-0.726657724383273,0.528715104803079,0.399710151702859,-0.221177127956784,0.312667708892356,-0.331464725175035,0.291725497975426,0.468893620487054,0.274464389114071,0.779562751914264,-0.0882400128349059,-0.662958077650977,1.02301199672081,-0.117723703610573,0.810161345691718,1.08515516810825,0.854537696229252,1.28931692924346,-1.72138986292636,1.05696421980381,0.375199220825206,-0.348435897718624,0.648409405255879,0.247358758149097,-0.312547978856403,-0.707362955303026],[2.16666745160071,1.39230733266585,1.43022777075804,0.611004422177983,-0.435199886802564,-1.0073982027924,-0.706652167102244,-0.168719934421299,0.898893469263742,-0.299321638485596,-0.244154319489067,-0.594253421020616,-0.879078195351211,0.177686800275276,0.291747107834121,0.0787615055977025,0.284686502665339,0.696432923516207,0.372220618365937,-0.252078468000066,-0.388240700078646,0.180189486011415,-0.0551475319720671,0.507307321759059,0.465698276464492,-0.156170829672247,1.14925701019249,1.07739812083033,0.565494055838962,0.615164985423322,0.774643509576431,0.498524870720621,-0.845731473296923,-1.3347920116215,-4.16180719672109,-4.33257467803231,-2.03125628867934,0.372775163906812,-0.312057881063828,-0.0152762320174856,1.26952992118586,-0.97356534544553,1.91944619709107,1.5365209171979,0.509598706861557,-2.2088470527049,-0.52039690026875,-0.618193746179531,-1.39246279574239,-0.584066649204812,-1.22867124115899,-0.963380273294644,-0.0898748797453008,-0.753464534312123,0.872466265163671,-0.425925535680295,-0.550967195632771,-0.45408643542641,0.577983661888651,-0.020298600044313,-0.103254748649614,-0.0672433614235955,0.342088947662037,0.337876655531732,0.0177295035987519,-0.209708076997007,0.0640267437182721,0.0749165785466278,1.34359871714126,0.530574858633547,1.06283821486832,-0.273407982747135,-0.63862518699526,1.03269478528118,-0.375396986019439,-0.116372823212759,-0.337564783683896,-0.424448892560463,-0.0579980920042215],[2.1666674516007,1.39230733266585,1.43022777075804,0.611004422177988,-0.435199886802563,-1.0073982027924,-0.706652167102245,-0.168719934421299,0.898893469263742,-0.299321638485596,-0.244154319489068,-0.594253421020618,-0.879078195351213,0.177686800275274,0.29174710783412,0.0787615055977016,0.284686502665339,0.696432923516207,0.372220618365937,-0.252078468000066,-0.388240700078646,0.180189486011415,-0.0551475319720668,0.50730732175906,0.465698276464493,-0.156170829672248,1.14925701019249,1.07739812083032,0.565494055838964,0.61516498542332,0.77464350957643,0.49852487072062,-0.845731473296925,-1.3347920116215,-4.16180719672109,-5.45975216696013,-4.24806282947323,3.27299568715896,0.9539241917209,0.603751533057832,2.28333749342474,0.789729929822771,2.02398163845228,3.40549043137221,-0.241465046258972,-1.62639975744465,-0.52734906663361,-1.17364965360114,-0.990335520302079,-0.00591028364282498,-1.97552002063702,-0.0757133298069711,0.914087799105774,-0.724265648527596,1.09880135161737,-1.19430002256042,0.0772538318992669,0.299164821293855,0.0852267156620138,0.589225156706141,0.211111671152698,-0.343511925458261,0.0802480579858347,1.26830426545073,0.0433267018993632,0.11138447923408,-0.644222611761023,0.146403654124689,1.84494928170122,1.09878096317707,2.03882303563461,-0.991647536716524,0.499430014774944,1.17971838047939,0.34287099705011,0.258068994878355,-0.184470695340006,-0.107398375808229,1.19257941560873],[1.85993035337644,1.37805239637792,1.44899870572357,-0.830133205952788,-1.67416009716306,-0.967347783809157,0.222827586452927,0.0981272548831179,0.306278571330743,-2.66602838838832,-0.667914854893066,-0.20522329134099,-0.720902907560515,0.488579969751808,0.113716144259308,-1.01417280182367,0.140182324194549,0.629998478779101,0.13244329932127,0.0523096540796322,-0.14007355193523,-0.539081848066094,-0.682401580836319,0.525824563877191,0.262287347145289,0.432663817173871,1.23361473308244,1.32245071259661,0.639440837605238,0.340328444667993,0.589037934428541,0.290805722519924,0.105487915192423,-1.12104928053172,-4.33797486986471,-3.67663571491799,-2.54136124836753,1.15447748866157,-0.28427853098055,-0.085850255280656,1.40421421411152,-0.854065323370179,1.53951342566256,2.11673140104969,-1.16638280506997,-2.50922063838528,-0.976020295636038,-1.48521289086239,-1.57403276481187,-0.375362760858811,-1.91567742380718,-0.166523470522776,0.714986773092193,-0.861087515274563,0.593032697883354,-1.08191067636615,-0.317784069718847,-0.0209726111293695,-0.0105578966281777,0.424655769617596,-0.0344526214558849,-0.0936013683466321,-0.0204582176658461,1.09425789529321,-0.17580192263369,-0.00337425978626849,-0.107691376267556,-0.126814983910925,1.53762858806786,0.76751824008852,1.58772324492364,-0.654908471557975,0.204032594254317,0.192021844090296,0.374464221589993,0.189519372610251,-0.377716509272824,-0.216643135288873,0.733591960136623],[2.15887684289949,1.12445551828687,1.36243327992573,0.330498898158449,-0.815781789611812,-0.871155211264458,-0.689942249487217,-0.150674557095182,0.768768245949967,-0.53159873064886,-0.422435327464896,-0.641425994282906,-0.89299830872109,0.184400442292903,0.340760152165458,0.0280057285482527,0.209915243307042,0.647875255859382,0.303759390962908,-0.191273926299106,-0.34424485745236,0.0180914635237561,-0.137361237311146,0.445777848013657,0.513023821863283,-0.0119195118711383,1.3324797032444,1.07535238257701,0.559750215814971,0.612276417695628,0.760543157658529,0.488126579054718,-0.863036880947899,-1.36131785260663,-4.35404206987396,-4.76262034834958,-1.72042512636862,0.977643132132919,0.50081528513595,0.49545759510209,1.72224388723916,-0.673281610946038,1.63569220838068,2.13281163517246,-0.643488025524039,-1.87646391158699,-0.553082653943016,-0.989041044353449,-0.929698424291492,-0.151271254817135,-1.498731070673,-0.0157686018870819,0.693663813963102,-0.750618613891036,0.571545421938828,-0.988758635484257,-0.102762739560524,0.0740756156485573,-0.0394933296912323,0.338474462368064,0.0138846669104278,-0.234638415116948,-0.00490111899471435,0.953948827923494,-0.109063587558268,-0.0374074525066959,-0.345809669770256,0.00559183796342178,1.37158450002996,0.752027048849504,1.35454266167216,-0.746057028258636,0.152020255828722,0.510107604547379,0.434632586995387,0.172860016340984,-0.262756493542045,-0.00843573945902476,0.843598410283915]],"fixedtz":false,"tzone":""},"evals":["attrs.interactionModel"],"jsHooks":[]}</script>
</div>
</div>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercice facultatif
</div>
</div>
<div class="callout-body-container callout-body">
<p>L’objectif de cet exercice est d’estimer un nouveau modèle jusqu’en 2022T4 pour faire une prévision jusqu’en 2023T1 :</p>
<ol type="1">
<li><p>Créer des indicatrices sur les 4 premiers trimestres de l’année 2020.</p></li>
<li><p>Estimer un nouveau modèle <code>dynlm</code> en ajoutant ces indicatrices.</p></li>
<li><p>Estimer un nouveau modèle espace-état.</p></li>
<li><p>Utiliser les variables exogènes du modèle jusqu’en 2023T1 (on peut pour cela appliquer la fonction <code>tvCoef::full_exogeneous_matrix()</code> sur le modèle <code>dynlm</code>) et la dernière ligne de la composante <code>"smoothed_states"</code> pour effectuer des prévisions sur 2023T1.</p></li>
</ol>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Indice (création des indicatrices)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>On pourra utiliser le programme suivant pour créer les indicatrices :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>ind <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">time</span>(manufacturing) <span class="sc">==</span> <span class="dv">2020</span>, <span class="fu">time</span>(manufacturing) <span class="sc">==</span> <span class="fl">2020.25</span>, <span class="fu">time</span>(manufacturing) <span class="sc">==</span> <span class="fl">2020.5</span>,</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">time</span>(manufacturing) <span class="sc">==</span> <span class="fl">2020.75</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>ind <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">apply</span>(ind,<span class="dv">2</span>, as.numeric), <span class="at">start =</span> <span class="fu">start</span>(manufacturing), <span class="at">frequency =</span> <span class="dv">4</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(ind) <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"ind2020Q%i"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">ts.union</span>(manufacturing, ind)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">colnames</span>(manufacturing), <span class="fu">colnames</span>(ind))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Estimation du modèle de régression linéaire :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>ind <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">time</span>(manufacturing) <span class="sc">==</span> <span class="dv">2020</span>, <span class="fu">time</span>(manufacturing) <span class="sc">==</span> <span class="fl">2020.25</span>, <span class="fu">time</span>(manufacturing) <span class="sc">==</span> <span class="fl">2020.5</span>,</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">time</span>(manufacturing) <span class="sc">==</span> <span class="fl">2020.75</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>ind <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">apply</span>(ind,<span class="dv">2</span>, as.numeric), <span class="at">start =</span> <span class="fu">start</span>(manufacturing), <span class="at">frequency =</span> <span class="dv">4</span>)</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(ind) <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"ind2020Q%i"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">ts.union</span>(manufacturing, ind)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">colnames</span>(manufacturing), <span class="fu">colnames</span>(ind))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">ts.union</span>(manufacturing, ind)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">colnames</span>(manufacturing), <span class="fu">colnames</span>(ind))</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>model_c5_complet <span class="ot">&lt;-</span> <span class="fu">dynlm</span>(</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> prod_c5 <span class="sc">~</span> overhang_ipi1_c5 <span class="sc">+</span> insee_bc_c5_m3 <span class="sc">+</span> insee_oscd_c5_m2</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="fu">diff</span>(insee_tppre_c5_m3, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">diff</span>(bdf_tuc_c5_m2, <span class="dv">1</span>) </span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> ind2020Q1 <span class="sc">+</span> ind2020Q2 <span class="sc">+</span> ind2020Q3 <span class="sc">+</span> ind2020Q4,</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_c5_complet)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Time series regression with "ts" data:
Start = 1990(2), End = 2022(4)

Call:
dynlm(formula = prod_c5 ~ overhang_ipi1_c5 + insee_bc_c5_m3 + 
    insee_oscd_c5_m2 + diff(insee_tppre_c5_m3, 1) + diff(bdf_tuc_c5_m2, 
    1) + ind2020Q1 + ind2020Q2 + ind2020Q3 + ind2020Q4, data = data)

Residuals:
     Min       1Q   Median       3Q      Max 
-2.50121 -0.40188  0.00267  0.48994  1.57418 

Coefficients:
                            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                -6.924304   3.182453  -2.176   0.0315 *  
overhang_ipi1_c5            0.115792   0.020951   5.527 1.91e-07 ***
insee_bc_c5_m3              0.065321   0.028967   2.255   0.0259 *  
insee_oscd_c5_m2           -0.009964   0.014757  -0.675   0.5008    
diff(insee_tppre_c5_m3, 1)  0.026459   0.011405   2.320   0.0220 *  
diff(bdf_tuc_c5_m2, 1)      0.361476   0.077713   4.651 8.49e-06 ***
ind2020Q1                  -5.195550   0.788939  -6.585 1.23e-09 ***
ind2020Q2                  -7.650566   1.654785  -4.623 9.53e-06 ***
ind2020Q3                  16.223534   1.482828  10.941  &lt; 2e-16 ***
ind2020Q4                   3.324056   0.810984   4.099 7.55e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.7705 on 121 degrees of freedom
  (131 observations effacées parce que manquantes)
Multiple R-squared:  0.9393,    Adjusted R-squared:  0.9348 
F-statistic: 208.1 on 9 and 121 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>prev_oos_lm_complet <span class="ot">&lt;-</span> <span class="fu">oos_prev</span>(model_c5_complet)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Estimation du modèle espace-état :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>model_ssm_complet <span class="ot">&lt;-</span> <span class="fu">ssm_lm</span>(model_c5_complet,</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">var_intercept =</span> <span class="fl">0.01</span>, <span class="at">fixed_var_intercept =</span> <span class="cn">FALSE</span>,</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">var_variables =</span> <span class="fl">0.01</span>, <span class="at">fixed_var_variables =</span> <span class="cn">FALSE</span>)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># # Rmq : on pourrait également fixer à 0 les variances des coefficients associées aux indicatrices :</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co"># model_ssm_complet &lt;- ssm_lm(model_c5_complet,</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="co">#         var_intercept = 0.01, fixed_var_intercept = FALSE,</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         var_variables = c(rep(0.01,5), rep(0, 4)), </span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         fixed_var_variables = c(rep(FALSE,5), rep(TRUE, 4)))</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>model_ssm_complet_oos <span class="ot">&lt;-</span> <span class="fu">ssm_lm_oos</span>(model_c5_complet, <span class="at">date =</span> <span class="dv">18</span><span class="sc">*</span><span class="dv">4</span>,</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">var_intercept =</span> <span class="fl">0.01</span>, <span class="at">fixed_var_intercept =</span> <span class="cn">FALSE</span>,</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">var_variables =</span> <span class="fl">0.01</span>, <span class="at">fixed_var_variables =</span> <span class="cn">FALSE</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Enfin, pour calculer les prévisions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>X_variables <span class="ot">=</span> <span class="fu">full_exogeneous_matrix</span>(model_c5_complet)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="fu">window</span>(X_variables, <span class="at">start =</span> <span class="dv">2022</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        (Intercept) overhang_ipi1_c5 insee_bc_c5_m3 insee_oscd_c5_m2
2022 Q1           1         7.629539          108.0              4.5
2022 Q2           1         2.870669          105.8             -2.2
2022 Q3           1         2.663170           97.9            -16.0
2022 Q4           1         1.979440           96.2            -24.6
2023 Q1           1         1.737138           98.7            -23.0
        diff(insee_tppre_c5_m3, 1) diff(bdf_tuc_c5_m2, 1) ind2020Q1 ind2020Q2
2022 Q1                      -20.1                  -0.23         0         0
2022 Q2                        0.1                   0.53         0         0
2022 Q3                       -9.7                   0.57         0         0
2022 Q4                       10.1                  -1.88         0         0
2023 Q1                       -1.9                  -0.49         0         0
        ind2020Q3 ind2020Q4
2022 Q1         0         0
2022 Q2         0         0
2022 Q3         0         0
2022 Q4         0         0
2023 Q1         0         0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>prevs_lm <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(X_variables <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="fu">coef</span>(model_c5_complet)))</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>prevs_lm <span class="ot">&lt;-</span> prevs_lm[<span class="fu">length</span>(prevs_lm)]</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>prevs_ssm <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(X_variables <span class="sc">%*%</span> <span class="fu">diag</span>(model_ssm_complet<span class="sc">$</span>smoothed_states[<span class="fu">nrow</span>(model_ssm_complet<span class="sc">$</span>smoothed_states), <span class="sc">-</span> <span class="fu">ncol</span>(model_ssm_complet<span class="sc">$</span>smoothed_states)]))</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>prevs_ssm <span class="ot">&lt;-</span> prevs_ssm[<span class="fu">length</span>(prevs_ssm)]</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>full_prevs <span class="ot">&lt;-</span> <span class="fu">ts.union</span>(prev_oos_lm_complet<span class="sc">$</span>prevision,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>                       model_ssm_complet_oos<span class="sc">$</span>prevision)</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>full_prevs <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">rbind</span>(full_prevs,</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">c</span>(prevs_lm, prevs_ssm)),</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">start =</span> <span class="fu">start</span>(full_prevs),</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">frequency =</span> <span class="fu">frequency</span>(full_prevs))</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>data_forecasts <span class="ot">&lt;-</span> <span class="fu">ts.union</span>(manufacturing[,<span class="st">"prod_c5"</span>], full_prevs)</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>data_forecasts <span class="ot">&lt;-</span> <span class="fu">window</span>(data_forecasts, <span class="at">start =</span> <span class="dv">2010</span>)</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_forecasts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"lm"</span>, <span class="st">"SSM"</span>)</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a><span class="fu">dygraph</span>(data_forecasts) <span class="sc">%&gt;%</span> </span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dyRangeSelector</span>(<span class="at">dateWindow =</span> <span class="fu">c</span>(<span class="st">"2018-01-01"</span>, <span class="st">"2023-03-01"</span>))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="dygraphs html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-8f735e529339a41a7382" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-8f735e529339a41a7382">{"x":{"attrs":{"labels":["quarter","y","lm","SSM"],"legend":"auto","retainDateWindow":false,"axes":{"x":{"pixelsPerLabel":60}},"showRangeSelector":true,"dateWindow":["2018-01-01T00:00:00.000Z","2023-03-01T00:00:00.000Z"],"rangeSelectorHeight":40,"rangeSelectorPlotFillColor":" #A7B1C4","rangeSelectorPlotStrokeColor":"#808FAB","interactionModel":"Dygraph.Interaction.defaultModel"},"scale":"quarterly","annotations":[],"shadings":[],"events":[],"format":"date","data":[["2010-01-01T00:00:00.000Z","2010-04-01T00:00:00.000Z","2010-07-01T00:00:00.000Z","2010-10-01T00:00:00.000Z","2011-01-01T00:00:00.000Z","2011-04-01T00:00:00.000Z","2011-07-01T00:00:00.000Z","2011-10-01T00:00:00.000Z","2012-01-01T00:00:00.000Z","2012-04-01T00:00:00.000Z","2012-07-01T00:00:00.000Z","2012-10-01T00:00:00.000Z","2013-01-01T00:00:00.000Z","2013-04-01T00:00:00.000Z","2013-07-01T00:00:00.000Z","2013-10-01T00:00:00.000Z","2014-01-01T00:00:00.000Z","2014-04-01T00:00:00.000Z","2014-07-01T00:00:00.000Z","2014-10-01T00:00:00.000Z","2015-01-01T00:00:00.000Z","2015-04-01T00:00:00.000Z","2015-07-01T00:00:00.000Z","2015-10-01T00:00:00.000Z","2016-01-01T00:00:00.000Z","2016-04-01T00:00:00.000Z","2016-07-01T00:00:00.000Z","2016-10-01T00:00:00.000Z","2017-01-01T00:00:00.000Z","2017-04-01T00:00:00.000Z","2017-07-01T00:00:00.000Z","2017-10-01T00:00:00.000Z","2018-01-01T00:00:00.000Z","2018-04-01T00:00:00.000Z","2018-07-01T00:00:00.000Z","2018-10-01T00:00:00.000Z","2019-01-01T00:00:00.000Z","2019-04-01T00:00:00.000Z","2019-07-01T00:00:00.000Z","2019-10-01T00:00:00.000Z","2020-01-01T00:00:00.000Z","2020-04-01T00:00:00.000Z","2020-07-01T00:00:00.000Z","2020-10-01T00:00:00.000Z","2021-01-01T00:00:00.000Z","2021-04-01T00:00:00.000Z","2021-07-01T00:00:00.000Z","2021-10-01T00:00:00.000Z","2022-01-01T00:00:00.000Z","2022-04-01T00:00:00.000Z","2022-07-01T00:00:00.000Z","2022-10-01T00:00:00.000Z","2023-01-01T00:00:00.000Z"],[-0.167783266259136,1.69005476811697,0.509685174055763,1.02110044270685,2.64191319590681,-0.567791159314213,-0.544266244339853,-0.818624262677459,-0.835556962597805,-1.0865971153298,0.591340833640719,-2.15206554747035,-0.0667548924309314,0.474627915152936,-0.726657724383273,0.528715104803079,0.399710151702859,-0.221177127956784,0.312667708892356,-0.331464725175035,0.291725497975426,0.468893620487054,0.274464389114071,0.779562751914264,-0.0882400128349059,-0.662958077650977,1.02301199672081,-0.117723703610573,0.810161345691718,1.08515516810825,0.854537696229252,1.28931692924346,-1.72138986292636,1.05696421980381,0.375199220825206,-0.348435897718624,0.648409405255879,0.247358758149097,-0.312547978856403,-0.707362955303026,-5.95847459504975,-18.6416116870877,24.2741503395746,3.89186669773947,0.280394795872585,-0.518957611005477,-0.54977177163672,-0.461241054975869,1.70018966711718,-0.302637750429946,-0.305796695603477,-0.38201388732837,null],[-0.21874822111444,1.14678994397449,-1.07831640780086,1.75823059116731,1.48895072193119,0.37477622629234,-2.21877122269024,-0.533186676518109,-0.675278494415403,-1.37371361342799,-0.589802104172525,-1.27997452197818,-1.00573199947518,-0.117249318837291,-0.804151284179511,0.875025283151804,-0.55641457136398,-0.554263488047868,-0.451913336076935,0.527495944237418,-0.051735828063333,-0.122082867457921,-0.149780832752672,0.287827436626796,0.312498711127092,0.00784567665297976,-0.231881337640345,-0.042953644343705,0.0756242853097573,1.31044613737323,0.517035494114748,1.07092634485028,-0.320823488632073,-0.601648912345408,1.09794988575385,-0.378203169754384,-0.110824763627969,-0.279127473912481,-0.424673216670773,0.0249304432654448,-0.771194908141357,-11.3145390981881,8.57637124535682,0.430534046352304,1.02337487304706,1.46923726962256,2.1166916395762,0.76834156038799,0.243863593173703,0.566903200622986,-0.0960188930294111,-0.592422425124903,-0.274222558724507],[0.448193181636783,1.74909574904903,-0.747387440517036,1.55707305286648,2.10986011672255,-0.661130838174589,-1.90111356851479,-0.57690732242507,-1.00029602753054,-1.23040678318521,-0.163601932729755,-1.6389752902439,-0.0452075795833396,0.670958163887926,-0.764353705691536,0.559612779833786,-1.00528876621862,-0.113491240681419,0.146884086466711,-0.0464372456697728,0.322041919655856,0.0113606871745559,-0.247753242112387,-0.00754505051094767,0.933438139789846,-0.112607023166491,-0.0383572260157961,-0.366357888104595,0.0150734076176383,1.44345730985665,0.751413370699418,1.35363263712115,-0.767153668298033,0.145546259684851,0.543167130965691,0.427190636391591,0.178706575186847,-0.236767520157501,-0.00800157945751501,0.875415205410301,0.265086737304131,-17.0550982944271,11.2943408965797,2.00909572598202,2.19604052206082,0.843434888678343,0.445620220575049,0.153492629884777,0.640066285713888,-0.0490345045999437,0.156869145256114,-1.05439598195343,-0.282767584688101]]},"evals":["attrs.interactionModel"],"jsHooks":[]}</script>
</div>
</div>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Notes de bas de page</h2>

<ol>
<li id="fn1"><p> L’avantage de <code>dynlm</code> par rapport à <code>lm</code> est qu’il permet de gérer directement la différenciation des variables sans avoir à créer de variable temporaire.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copié");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copié");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="AQLT/AteliertvCoef" data-repo-id="R_kgDOJHHw_w" data-category="Announcements" data-category-id="DIC_kwDOIepag84CSt5_" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="fr" crossorigin="anonymous" data-loading="lazy" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2023, Claire de Rosamel, Alain Quartier-la-Tente, Insee</div>   
  </div>
</footer>



</body></html>